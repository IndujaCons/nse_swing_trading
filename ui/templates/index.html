<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nifty 500 RS Screener</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #e8f0f2;
            --bg-white: #f0f5f7;
            --bg-card: #e3ecef;
            --text-primary: #2c3e50;
            --text-secondary: #546e7a;
            --text-muted: #78909c;
            --border-color: #cfd8dc;
            --green: #27ae60;
            --green-light: #d5f5e3;
            --blue: #3498db;
            --blue-light: #d6eaf8;
            --red: #e74c3c;
            --red-light: #fadbd8;
            --orange: #e67e22;
            --orange-light: #fdebd0;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Consolas', 'Menlo', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 13px;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .refresh-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .refresh-btn:hover {
            background: var(--bg-card);
        }

        .refresh-btn.loading {
            opacity: 0.6;
            cursor: wait;
        }

        .refresh-icon {
            width: 14px;
            height: 14px;
        }

        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--red);
        }

        .status-dot.connected {
            background: var(--green);
        }

        /* Main Layout */
        .container {
            display: flex;
            height: calc(100vh - 41px);
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 200px;
            background: var(--bg-white);
            border-right: 1px solid var(--border-color);
            padding: 12px;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 14px;
        }

        .section-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 6px 10px;
            font-family: inherit;
            font-size: 11px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            margin-bottom: 6px;
            background: var(--bg-white);
            color: var(--text-primary);
        }

        .btn:hover {
            background: var(--bg-card);
        }

        .btn-primary {
            background: var(--green);
            color: white;
            border-color: var(--green);
        }

        .btn-primary:hover {
            background: #43a047;
        }

        .input-field {
            width: 100%;
            padding: 6px 8px;
            font-family: inherit;
            font-size: 11px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 6px;
            background: var(--bg-white);
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            font-size: 11px;
        }

        .setting-label {
            color: var(--text-secondary);
        }

        .setting-value {
            font-weight: 500;
            color: var(--text-primary);
        }

        .setting-input {
            width: 60px;
            padding: 4px 6px;
            font-family: inherit;
            font-size: 12px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            text-align: right;
            background: var(--bg-white);
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--green);
        }

        .setting-select {
            width: 100px;
            padding: 4px 6px;
            font-family: inherit;
            font-size: 11px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background: var(--bg-white);
            cursor: pointer;
        }

        .setting-select:focus {
            outline: none;
            border-color: var(--green);
        }

        .connection-box {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
        }

        .connection-box.connected {
            background: var(--green-light);
            border-color: var(--green);
            color: var(--green);
        }

        .user-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 10px;
            margin-bottom: 6px;
            font-size: 11px;
        }

        .user-card .user-card-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .user-card .user-card-header .status-dot {
            width: 7px;
            height: 7px;
        }

        .user-card .user-card-name {
            font-weight: 600;
            flex: 1;
        }

        .user-card .user-card-status {
            color: var(--text-muted);
            font-size: 10px;
        }

        .user-card.connected {
            border-color: var(--green);
        }

        .user-card.connected .user-card-status {
            color: var(--green);
        }

        .user-card .user-card-actions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .user-card .user-card-actions .btn {
            font-size: 10px;
            padding: 3px 8px;
        }

        .user-card .token-row {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .user-card .token-row input {
            flex: 1;
            font-size: 10px;
            padding: 3px 6px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-family: inherit;
        }

        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }

        .toggle {
            width: 40px;
            height: 22px;
            background: #ccc;
            border-radius: 11px;
            position: relative;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .toggle.active {
            background: var(--green);
        }

        .toggle.active::after {
            transform: translateX(18px);
        }

        .divider {
            height: 1px;
            background: var(--border-color);
            margin: 10px 0;
        }

        /* Main Content */
        .main {
            flex: 1;
            padding: 10px;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .panels {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            min-width: 700px;
            height: calc(100vh - 60px);
        }

        .panel {
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        .panel-header {
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .panel.fresh .panel-title { color: var(--green); }
        .panel.sectoral .panel-title { color: var(--orange); }
        .panel.inrs .panel-title { color: var(--blue); }
        .panel.exit .panel-title { color: var(--red); }

        .panel-count {
            font-size: 12px;
            color: var(--text-muted);
            background: var(--bg-card);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .panel-body {
            max-height: calc(50vh - 100px);
            overflow-y: auto;
        }

        /* Stock Table */
        .stock-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stock-table th {
            text-align: left;
            padding: 6px 8px;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
        }

        .stock-table th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .stock-table th.sortable:hover {
            color: var(--text-primary);
        }

        .stock-table th.sortable::after {
            content: ' \25B8';
            font-size: 8px;
            opacity: 0.3;
        }

        .stock-table th.sortable.asc::after {
            content: ' \25B4';
            opacity: 1;
        }

        .stock-table th.sortable.desc::after {
            content: ' \25BE';
            opacity: 1;
        }

        .stock-table td {
            padding: 5px 8px;
            font-size: 11px;
            border-bottom: 1px solid var(--border-color);
        }

        .stock-table tr:last-child td {
            border-bottom: none;
        }

        .stock-table tr:hover {
            background: var(--bg-card);
        }

        .ticker {
            font-weight: 600;
            color: var(--text-primary);
        }

        .price {
            color: var(--text-secondary);
        }

        .rs-value {
            font-weight: 500;
        }

        .rs-value.positive {
            color: var(--green);
        }

        .rs-value.negative {
            color: var(--red);
        }

        .ema-pct {
            font-size: 12px;
        }

        .ema-pct.positive {
            color: var(--green);
        }

        .ema-pct.negative {
            color: var(--red);
        }

        .sector-strength {
            font-size: 10px;
            font-weight: 500;
        }

        .sector-strength.positive {
            color: var(--green);
        }

        .sector-strength.negative {
            color: var(--red);
        }

        .trade-btn {
            padding: 4px 10px;
            font-family: inherit;
            font-size: 11px;
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .trade-btn:hover {
            background: var(--green-light);
            border-color: var(--green);
            color: var(--green);
        }

        .trade-btn.sell:hover {
            background: var(--red-light);
            border-color: var(--red);
            color: var(--red);
        }

        .trade-btn.executed {
            background: var(--green-light);
            border-color: var(--green);
            color: var(--green);
        }

        /* Loading State */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .loader {
            width: 30px;
            height: 30px;
            border: 2px solid var(--border-color);
            border-top-color: var(--green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        .progress-text {
            font-size: 12px;
            margin-top: 8px;
            color: var(--text-muted);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 13px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 16px;
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
        }

        .toast.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 3px solid var(--green);
        }

        .toast.error {
            border-left: 3px solid var(--red);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-card);
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #bbb;
        }

        .last-updated {
            font-size: 12px;
            color: var(--text-muted);
        }

        .hidden {
            display: none !important;
        }

        /* Strategy Tabs */
        .strategy-tabs {
            display: flex;
            gap: 0;
            margin-right: 16px;
        }

        .strategy-tab {
            padding: 6px 14px;
            font-family: inherit;
            font-size: 12px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            background: var(--bg-white);
            color: var(--text-muted);
            font-weight: 500;
        }

        .strategy-tab:first-child {
            border-radius: 4px 0 0 4px;
        }

        .strategy-tab:nth-child(2) {
            border-left: none;
            border-radius: 0;
        }

        .strategy-tab:last-child {
            border-radius: 0 4px 4px 0;
            border-left: none;
        }

        .strategy-tab.active {
            background: var(--green);
            color: white;
            border-color: var(--green);
        }

        /* Live Signals panel colors */
        .panel.ls-j-signals .panel-title { color: var(--green); }
        .panel.ls-t-signals .panel-title { color: var(--blue); }
        .panel.ls-positions .panel-title { color: var(--green); }
        .panel.ls-exits .panel-title { color: var(--red); }

        .ls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 10px;
            min-width: 700px;
        }
        .ls-bottom-row {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
        }

        .buy-input {
            width: 70px;
            padding: 3px 6px;
            font-family: inherit;
            font-size: 11px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            text-align: right;
        }

        .score-badge {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
        }

        .score-high { background: var(--green-light); color: var(--green); }
        .score-mid { background: var(--orange-light); color: var(--orange); }
        .score-low { background: var(--bg-card); color: var(--text-muted); }

        .cond-pass { color: var(--green); font-weight: 600; }
        .cond-fail { color: var(--red); font-weight: 600; }

        .conditions-badge {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
        }
        .conditions-4 { background: var(--green-light); color: var(--green); }
        .conditions-3 { background: var(--orange-light); color: var(--orange); }
        .conditions-2, .conditions-1, .conditions-0 { background: var(--red-light); color: var(--red); }

        .setting-static {
            font-size: 11px;
            color: var(--text-muted);
            padding: 5px 0;
        }

        /* Backtest styles */
        .backtest-controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .backtest-controls .section-title {
            margin-bottom: 6px;
        }

        .backtest-select {
            width: 100%;
            padding: 5px 6px;
            font-family: inherit;
            font-size: 11px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background: var(--bg-white);
            cursor: pointer;
            margin-bottom: 6px;
        }

        .backtest-select:focus {
            outline: none;
            border-color: var(--green);
        }

        .btn-backtest {
            background: var(--blue);
            color: white;
            border-color: var(--blue);
        }

        .btn-backtest:hover {
            background: #2980b9;
        }

        .btn-backtest.loading {
            opacity: 0.6;
            cursor: wait;
        }

        .btn-back {
            background: var(--bg-white);
            color: var(--text-secondary);
            border-color: var(--border-color);
            font-size: 11px;
            margin-bottom: 10px;
        }

        .btn-back:hover {
            background: var(--bg-card);
        }

        .backtest-results {
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 700px;
        }

        .backtest-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .summary-card {
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 12px;
            text-align: center;
        }

        .summary-card .label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .summary-card .value {
            font-size: 16px;
            font-weight: 600;
            margin-top: 2px;
        }

        .summary-card .value.positive { color: var(--green); }
        .summary-card .value.negative { color: var(--red); }

        .backtest-trades-panel {
            flex: 1;
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .backtest-trades-panel .panel-body {
            flex: 1;
            overflow-y: auto;
            max-height: none;
        }

        .pnl-positive { color: var(--green); font-weight: 500; }
        .pnl-negative { color: var(--red); font-weight: 500; }

        /* Trade Explain styles */
        .trade-explain {
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            padding-bottom: 20px;
        }
        .explain-banner {
            border-radius: 6px;
            padding: 14px 18px;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
        }
        .explain-banner.winner {
            background: var(--green-light);
            color: #1a7a3a;
            border: 1px solid #a3dfbb;
        }
        .explain-banner.loser {
            background: var(--red-light);
            color: #b03a2e;
            border: 1px solid #f1948a;
        }
        .explain-card {
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 14px 16px;
        }
        .explain-card-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 6px;
        }
        .explain-card p {
            margin: 4px 0;
            font-size: 12px;
            line-height: 1.6;
        }
        .explain-card .detail-label {
            color: var(--text-muted);
            display: inline-block;
            min-width: 140px;
        }
        .explain-card .detail-value {
            font-weight: 500;
        }
        .explain-desc {
            font-style: italic;
            color: var(--text-secondary);
            margin-bottom: 8px !important;
        }
        .exit-stage {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
        }
        .exit-stage:last-child { border-bottom: none; }
        .exit-stage-num {
            background: var(--bg-card);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .exit-stage-detail { flex: 1; }
        .exit-stage-detail .exit-line {
            font-size: 12px;
            margin: 1px 0;
        }
        .exit-stage-detail .exit-reason {
            font-size: 11px;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Batch backtest matrix styles */
        .batch-results {
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .batch-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            padding: 4px 0;
        }

        .batch-table-container {
            flex: 1;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-white);
        }

        .batch-table {
            border-collapse: collapse;
            font-size: 11px;
            white-space: nowrap;
        }

        .batch-table thead th {
            position: sticky;
            top: 0;
            background: var(--bg-card);
            border-bottom: 2px solid var(--border-color);
            padding: 6px 8px;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            z-index: 2;
        }

        .batch-table thead th.sticky-col {
            left: 0;
            z-index: 3;
        }

        .batch-table td {
            padding: 4px 8px;
            border-bottom: 1px solid var(--border-color);
            text-align: right;
        }

        .batch-table td.sticky-col {
            position: sticky;
            left: 0;
            background: var(--bg-white);
            z-index: 1;
            text-align: left;
            font-weight: 600;
            border-right: 1px solid var(--border-color);
        }

        .batch-table tr:hover td {
            background: var(--bg-card);
        }

        .batch-table tr:hover td.sticky-col {
            background: var(--bg-card);
        }

        .batch-table tr.batch-total-row td {
            border-top: 2px solid var(--text-primary);
            font-weight: 700;
            font-size: 12px;
            background: var(--bg-card);
        }

        .batch-table tr.batch-total-row td.sticky-col {
            background: var(--bg-card);
        }

        .batch-cell-good { color: var(--green); font-weight: 600; }
        .batch-cell-ok { color: #6ab04c; }
        .batch-cell-bad { color: var(--red); }
        .batch-cell-na { color: var(--text-muted); }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>Nifty 500 Screener</h1>
        <div class="header-right">
            <div class="strategy-tabs">
                <button class="strategy-tab active" onclick="switchStrategy('rs')">Watchlist</button>
                <button class="strategy-tab" onclick="switchStrategy('live_signals')">Live Signals</button>
                <button class="strategy-tab" onclick="switchStrategy('momentum')">Backtest</button>
                <button class="strategy-tab" onclick="switchStrategy('trade_explain')">Trade Explain</button>
            </div>
            <span class="last-updated" id="last-updated">--</span>
            <button class="refresh-btn" id="refresh-btn" onclick="refreshData()">
                <svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/>
                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                Refresh
            </button>
            <div class="status-indicator" id="header-status">
                <span class="status-dot" id="connection-dot"></span>
                <span id="connection-status">Disconnected</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="section" id="zerodha-section">
                <div class="section-title">Zerodha</div>
                <div id="user-cards-container">
                    <!-- Per-user cards rendered by JS -->
                </div>
                <div style="margin-top:8px;">
                    <label style="font-size:11px;color:var(--text-muted);">Trade as:</label>
                    <select class="setting-select" id="trade-as-select" style="width:100%;margin-top:2px;">
                    </select>
                </div>
            </div>

            <div class="divider"></div>

            <div class="section" id="rs-settings">
                <div class="section-title">Watchlist Settings</div>
                <div class="setting-row">
                    <span class="setting-label">RS Period</span>
                    <select class="setting-select" id="rs-period">
                        <option value="21">21 days</option>
                        <option value="63" selected>63 days</option>
                        <option value="126">126 days</option>
                        <option value="252">252 days</option>
                    </select>
                </div>
                <div class="setting-row">
                    <span class="setting-label">EMA Period</span>
                    <select class="setting-select" id="ema-period">
                        <option value="21">21 days</option>
                        <option value="63" selected>63 days</option>
                        <option value="126">126 days</option>
                        <option value="252">252 days</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()" style="margin-top: 8px;">Save Settings</button>
            </div>

            <div class="section hidden" id="live-signals-settings">
                <div class="section-title">Scan Universe</div>
                <div class="setting-row">
                    <span class="setting-label">Universe</span>
                    <select class="setting-select" id="ls-universe">
                        <option value="50" selected>Nifty 50</option>
                        <option value="100">Nifty 100</option>
                        <option value="150">Midcap 150</option>
                    </select>
                </div>
                <div class="section-title" style="margin-top: 12px;">Scan Date</div>
                <div class="setting-row">
                    <span class="setting-label">Date</span>
                    <input type="date" id="ls-scan-date" class="setting-select" style="width:130px;">
                </div>
                <div class="setting-row hidden" id="ls-historical-info" style="font-size:11px;color:var(--yellow,#f0c040);align-items:center;">
                    <span>Viewing historical signals</span>
                    <button class="btn" onclick="clearScanDate()" style="padding:2px 8px;font-size:11px;margin-left:6px;">Today</button>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()" style="margin-top: 8px;">Save</button>
            </div>

            <div class="section hidden" id="momentum-settings">
                <div class="backtest-controls">
                    <div class="section-title">Backtest</div>
                    <select class="backtest-select" id="backtest-strategy">
                        <option value="J">Strategy J — weekly support</option>
                        <option value="T">Strategy T — Keltner pullback</option>
                        <option value="R">Strategy R — RSI divergence</option>
                    </select>
                    <select class="backtest-select" id="backtest-symbol">
                        <option value="">-- Select Symbol --</option>
                        <option value="ABB">ABB</option>
                        <option value="ADANIENT">ADANIENT</option>
                        <option value="ADANIENSOL">ADANIENSOL</option>
                        <option value="ADANIGREEN">ADANIGREEN</option>
                        <option value="ADANIPORTS">ADANIPORTS</option>
                        <option value="ADANIPOWER">ADANIPOWER</option>
                        <option value="AMBUJACEM">AMBUJACEM</option>
                        <option value="APOLLOHOSP">APOLLOHOSP</option>
                        <option value="ASIANPAINT">ASIANPAINT</option>
                        <option value="ATGL">ATGL</option>
                        <option value="AUROPHARMA">AUROPHARMA</option>
                        <option value="AXISBANK">AXISBANK</option>
                        <option value="BAJAJ-AUTO">BAJAJ-AUTO</option>
                        <option value="BAJAJFINSV">BAJAJFINSV</option>
                        <option value="BAJAJHLDNG">BAJAJHLDNG</option>
                        <option value="BAJFINANCE">BAJFINANCE</option>
                        <option value="BANKBARODA">BANKBARODA</option>
                        <option value="BEL">BEL</option>
                        <option value="BHARTIARTL">BHARTIARTL</option>
                        <option value="BHEL">BHEL</option>
                        <option value="BOSCHLTD">BOSCHLTD</option>
                        <option value="BPCL">BPCL</option>
                        <option value="BRITANNIA">BRITANNIA</option>
                        <option value="CANBK">CANBK</option>
                        <option value="CHOLAFIN">CHOLAFIN</option>
                        <option value="CIPLA">CIPLA</option>
                        <option value="COALINDIA">COALINDIA</option>
                        <option value="COLPAL">COLPAL</option>
                        <option value="DABUR">DABUR</option>
                        <option value="DLF">DLF</option>
                        <option value="DRREDDY">DRREDDY</option>
                        <option value="EICHERMOT">EICHERMOT</option>
                        <option value="ETERNAL">ETERNAL</option>
                        <option value="GAIL">GAIL</option>
                        <option value="GODREJCP">GODREJCP</option>
                        <option value="GRASIM">GRASIM</option>
                        <option value="HAL">HAL</option>
                        <option value="HAVELLS">HAVELLS</option>
                        <option value="HCLTECH">HCLTECH</option>
                        <option value="HDFCBANK">HDFCBANK</option>
                        <option value="HDFCLIFE">HDFCLIFE</option>
                        <option value="HEROMOTOCO">HEROMOTOCO</option>
                        <option value="HINDALCO">HINDALCO</option>
                        <option value="HINDUNILVR">HINDUNILVR</option>
                        <option value="ICICIBANK">ICICIBANK</option>
                        <option value="ICICIGI">ICICIGI</option>
                        <option value="ICICIPRULI">ICICIPRULI</option>
                        <option value="INDIGO">INDIGO</option>
                        <option value="INDUSINDBK">INDUSINDBK</option>
                        <option value="INDUSTOWER">INDUSTOWER</option>
                        <option value="INFY">INFY</option>
                        <option value="IOC">IOC</option>
                        <option value="IRFC">IRFC</option>
                        <option value="ITC">ITC</option>
                        <option value="JIOFIN">JIOFIN</option>
                        <option value="JSWENERGY">JSWENERGY</option>
                        <option value="JSWSTEEL">JSWSTEEL</option>
                        <option value="KOTAKBANK">KOTAKBANK</option>
                        <option value="LICI">LICI</option>
                        <option value="LODHA">LODHA</option>
                        <option value="LT">LT</option>
                        <option value="LUPIN">LUPIN</option>
                        <option value="M&M">M&amp;M</option>
                        <option value="MANKIND">MANKIND</option>
                        <option value="MARICO">MARICO</option>
                        <option value="MARUTI">MARUTI</option>
                        <option value="MOTHERSON">MOTHERSON</option>
                        <option value="NAUKRI">NAUKRI</option>
                        <option value="NESTLEIND">NESTLEIND</option>
                        <option value="NHPC">NHPC</option>
                        <option value="NTPC">NTPC</option>
                        <option value="ONGC">ONGC</option>
                        <option value="PFC">PFC</option>
                        <option value="PIDILITIND">PIDILITIND</option>
                        <option value="PNB">PNB</option>
                        <option value="POLYCAB">POLYCAB</option>
                        <option value="POWERGRID">POWERGRID</option>
                        <option value="RECLTD">RECLTD</option>
                        <option value="RELIANCE">RELIANCE</option>
                        <option value="SBIN">SBIN</option>
                        <option value="SBILIFE">SBILIFE</option>
                        <option value="SHREECEM">SHREECEM</option>
                        <option value="SIEMENS">SIEMENS</option>
                        <option value="SRF">SRF</option>
                        <option value="SUNPHARMA">SUNPHARMA</option>
                        <option value="TATACONSUM">TATACONSUM</option>
                        <option value="TATAPOWER">TATAPOWER</option>
                        <option value="TATASTEEL">TATASTEEL</option>
                        <option value="TCS">TCS</option>
                        <option value="TECHM">TECHM</option>
                        <option value="TITAN">TITAN</option>
                        <option value="TORNTPHARM">TORNTPHARM</option>
                        <option value="TRENT">TRENT</option>
                        <option value="TVSMOTOR">TVSMOTOR</option>
                        <option value="ULTRACEMCO">ULTRACEMCO</option>
                        <option value="UNITDSPR">UNITDSPR</option>
                        <option value="VEDL">VEDL</option>
                        <option value="WIPRO">WIPRO</option>
                        <option value="ZOMATO">ZOMATO</option>
                    </select>
                    <div style="display:flex; gap:4px; align-items:center; margin:4px 0;">
                        <label style="font-size:11px; color:var(--text-secondary); width:32px;">From</label>
                        <input type="date" class="backtest-select" id="backtest-from" style="flex:1;">
                    </div>
                    <div style="display:flex; gap:4px; align-items:center; margin:4px 0;">
                        <label style="font-size:11px; color:var(--text-secondary); width:32px;">To</label>
                        <input type="date" class="backtest-select" id="backtest-to" style="flex:1;">
                    </div>
                    <button class="btn btn-backtest" id="run-backtest-btn" onclick="runBacktest()">Run Backtest</button>
                    <div style="margin: 8px 0; height: 1px; background: var(--border-color);"></div>
                    <div class="section-title">Batch</div>
                    <button class="btn btn-backtest" id="run-batch-btn" onclick="runBatchBacktest(50)">Backtest All (Nifty 50)</button>
                    <button class="btn btn-backtest" id="run-batch100-btn" onclick="runBatchBacktest(100)">Backtest All (Nifty 100)</button>
                    <div style="margin: 8px 0; height: 1px; background: var(--border-color);"></div>
                    <div class="section-title">Portfolio</div>
                    <select class="backtest-select" id="portfolio-capital">
                        <option value="10">10L Capital</option>
                        <option value="20">20L Capital</option>
                        <option value="50">50L Capital</option>
                        <option value="80">80L Capital</option>
                        <option value="100">1 Cr Capital</option>
                    </select>
                    <select class="backtest-select" id="portfolio-per-stock">
                        <option value="50000">50K / trade</option>
                        <option value="100000">1L / trade</option>
                        <option value="200000">2L / trade</option>
                        <option value="500000">5L / trade</option>
                    </select>
                    <select class="backtest-select" id="portfolio-strategy">
                        <option value="JTR3">J + T + R (3-Stage)</option>
                        <option value="JT3">J + T (3-Stage)</option>
                        <option value="J3">J Only (3-Stage)</option>
                        <option value="T3">T Only (3-Stage)</option>
                        <option value="R3">R Only (3-Stage)</option>
                    </select>
                    <select class="backtest-select" id="portfolio-entries-per-day">
                        <option value="1">1 trade / day</option>
                        <option value="2">2 trades / day</option>
                        <option value="3" selected>3 trades / day</option>
                    </select>
                    <button class="btn btn-backtest" id="run-portfolio50-btn" onclick="runPortfolioBacktest(50)">Backtest (Nifty 50)</button>
                    <button class="btn btn-backtest" id="run-portfolio100-btn" onclick="runPortfolioBacktest(100)">Backtest (Nifty 100)</button>
                </div>
            </div>

            <div class="divider"></div>

            <div class="section">
                <div class="section-title">Market Info</div>
                <div class="setting-row">
                    <span class="setting-label">Nifty 50 Return</span>
                    <span class="setting-value" id="nifty-return">--</span>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Stocks Processed</span>
                    <span class="setting-value" id="stocks-processed">--</span>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Paper Trades</span>
                    <span class="setting-value" id="paper-trades-count">0</span>
                </div>
            </div>

            <div class="section hidden" id="trade-explain-settings">
                <div class="section-title">Trade Explain</div>
                <select class="backtest-select" id="explain-strategy">
                    <option value="J">Strategy J — weekly support</option>
                    <option value="T">Strategy T — Keltner pullback</option>
                    <option value="R">Strategy R — RSI divergence</option>
                </select>
                <select class="backtest-select" id="explain-symbol">
                    <option value="">-- Select Symbol --</option>
                    <option value="ABB">ABB</option>
                    <option value="ADANIENT">ADANIENT</option>
                    <option value="ADANIENSOL">ADANIENSOL</option>
                    <option value="ADANIGREEN">ADANIGREEN</option>
                    <option value="ADANIPORTS">ADANIPORTS</option>
                    <option value="ADANIPOWER">ADANIPOWER</option>
                    <option value="AMBUJACEM">AMBUJACEM</option>
                    <option value="APOLLOHOSP">APOLLOHOSP</option>
                    <option value="ASIANPAINT">ASIANPAINT</option>
                    <option value="ATGL">ATGL</option>
                    <option value="AUROPHARMA">AUROPHARMA</option>
                    <option value="AXISBANK">AXISBANK</option>
                    <option value="BAJAJ-AUTO">BAJAJ-AUTO</option>
                    <option value="BAJAJFINSV">BAJAJFINSV</option>
                    <option value="BAJAJHLDNG">BAJAJHLDNG</option>
                    <option value="BANKBARODA">BANKBARODA</option>
                    <option value="BEL">BEL</option>
                    <option value="BHARTIARTL">BHARTIARTL</option>
                    <option value="BHEL">BHEL</option>
                    <option value="BPCL">BPCL</option>
                    <option value="BOSCHLTD">BOSCHLTD</option>
                    <option value="BRITANNIA">BRITANNIA</option>
                    <option value="CANBK">CANBK</option>
                    <option value="CHOLAFIN">CHOLAFIN</option>
                    <option value="CIPLA">CIPLA</option>
                    <option value="COALINDIA">COALINDIA</option>
                    <option value="COLPAL">COLPAL</option>
                    <option value="DABUR">DABUR</option>
                    <option value="DLF">DLF</option>
                    <option value="DRREDDY">DRREDDY</option>
                    <option value="EICHERMOT">EICHERMOT</option>
                    <option value="GAIL">GAIL</option>
                    <option value="GODREJCP">GODREJCP</option>
                    <option value="GRASIM">GRASIM</option>
                    <option value="HAL">HAL</option>
                    <option value="HAVELLS">HAVELLS</option>
                    <option value="HCLTECH">HCLTECH</option>
                    <option value="HDFCBANK">HDFCBANK</option>
                    <option value="HDFCLIFE">HDFCLIFE</option>
                    <option value="HEROMOTOCO">HEROMOTOCO</option>
                    <option value="HINDALCO">HINDALCO</option>
                    <option value="HINDUNILVR">HINDUNILVR</option>
                    <option value="ICICIBANK">ICICIBANK</option>
                    <option value="ICICIGI">ICICIGI</option>
                    <option value="ICICIPRULI">ICICIPRULI</option>
                    <option value="INDIGO">INDIGO</option>
                    <option value="INDUSINDBK">INDUSINDBK</option>
                    <option value="INDUSTOWER">INDUSTOWER</option>
                    <option value="INFY">INFY</option>
                    <option value="IOC">IOC</option>
                    <option value="IRFC">IRFC</option>
                    <option value="ITC">ITC</option>
                    <option value="JIOFIN">JIOFIN</option>
                    <option value="JSWENERGY">JSWENERGY</option>
                    <option value="JSWSTEEL">JSWSTEEL</option>
                    <option value="KOTAKBANK">KOTAKBANK</option>
                    <option value="LICI">LICI</option>
                    <option value="LODHA">LODHA</option>
                    <option value="LT">LT</option>
                    <option value="LUPIN">LUPIN</option>
                    <option value="M&M">M&amp;M</option>
                    <option value="MANKIND">MANKIND</option>
                    <option value="MARICO">MARICO</option>
                    <option value="MARUTI">MARUTI</option>
                    <option value="MOTHERSON">MOTHERSON</option>
                    <option value="NAUKRI">NAUKRI</option>
                    <option value="NESTLEIND">NESTLEIND</option>
                    <option value="NHPC">NHPC</option>
                    <option value="NTPC">NTPC</option>
                    <option value="ONGC">ONGC</option>
                    <option value="PFC">PFC</option>
                    <option value="PIDILITIND">PIDILITIND</option>
                    <option value="PNB">PNB</option>
                    <option value="POLYCAB">POLYCAB</option>
                    <option value="POWERGRID">POWERGRID</option>
                    <option value="RECLTD">RECLTD</option>
                    <option value="RELIANCE">RELIANCE</option>
                    <option value="SBIN">SBIN</option>
                    <option value="SBILIFE">SBILIFE</option>
                    <option value="SHREECEM">SHREECEM</option>
                    <option value="SIEMENS">SIEMENS</option>
                    <option value="SRF">SRF</option>
                    <option value="SUNPHARMA">SUNPHARMA</option>
                    <option value="TATACONSUM">TATACONSUM</option>
                    <option value="TATAPOWER">TATAPOWER</option>
                    <option value="TATASTEEL">TATASTEEL</option>
                    <option value="TCS">TCS</option>
                    <option value="TECHM">TECHM</option>
                    <option value="TITAN">TITAN</option>
                    <option value="TORNTPHARM">TORNTPHARM</option>
                    <option value="TRENT">TRENT</option>
                    <option value="TVSMOTOR">TVSMOTOR</option>
                    <option value="ULTRACEMCO">ULTRACEMCO</option>
                    <option value="UNITDSPR">UNITDSPR</option>
                    <option value="VEDL">VEDL</option>
                    <option value="WIPRO">WIPRO</option>
                    <option value="ZOMATO">ZOMATO</option>
                </select>
                <div style="display:flex; gap:4px; align-items:center; margin:4px 0;">
                    <label style="font-size:11px; color:var(--text-secondary); width:52px;">Entry</label>
                    <input type="date" class="backtest-select" id="explain-date" style="flex:1;">
                </div>
                <button class="btn btn-backtest" id="run-explain-btn" onclick="explainTrade()">Explain Trade</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Watchlist Panels -->
            <div class="panels" id="rs-panels">
                <div class="panel sectoral">
                    <div class="panel-header">
                        <span class="panel-title">Sectoral Indices</span>
                        <span class="panel-count" id="sectoral-count">0</span>
                    </div>
                    <div class="panel-body" id="sectoral-panel">
                        <div class="loading-container">
                            <div class="loader"></div>
                            <span>Loading...</span>
                        </div>
                    </div>
                </div>

                <div class="panel fresh">
                    <div class="panel-header">
                        <span class="panel-title">Nifty 50</span>
                        <span class="panel-count" id="nifty50-count">0</span>
                    </div>
                    <div class="panel-body" id="nifty50-panel">
                        <div class="loading-container">
                            <div class="loader"></div>
                            <span>Loading...</span>
                        </div>
                    </div>
                </div>

                <div class="panel inrs">
                    <div class="panel-header">
                        <span class="panel-title">Nifty 100</span>
                        <span class="panel-count" id="nifty100-count">0</span>
                    </div>
                    <div class="panel-body" id="nifty100-panel">
                        <div class="loading-container">
                            <div class="loader"></div>
                            <span>Loading...</span>
                        </div>
                    </div>
                </div>

                <div class="panel exit">
                    <div class="panel-header">
                        <span class="panel-title">Midcap 150</span>
                        <span class="panel-count" id="midcap150-count">0</span>
                    </div>
                    <div class="panel-body" id="midcap150-panel">
                        <div class="loading-container">
                            <div class="loader"></div>
                            <span>Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Signals Panels -->
            <div class="ls-grid hidden" id="live-signals-panels">
                <div class="panel ls-j-signals">
                    <div class="panel-header">
                        <span class="panel-title">J — Weekly Support</span>
                        <span class="panel-count" id="ls-j-count">0</span>
                    </div>
                    <div class="panel-body" id="ls-j-panel">
                        <div class="empty-state">Click Refresh to scan</div>
                    </div>
                </div>

                <div class="panel ls-t-signals">
                    <div class="panel-header">
                        <span class="panel-title">T — Keltner Pullback</span>
                        <span class="panel-count" id="ls-t-count">0</span>
                    </div>
                    <div class="panel-body" id="ls-t-panel">
                        <div class="empty-state">Click Refresh to scan</div>
                    </div>
                </div>

                <div class="panel ls-r-signals">
                    <div class="panel-header">
                        <span class="panel-title" style="color:#ab47bc;">R — RSI Divergence</span>
                        <span class="panel-count" id="ls-r-count">0</span>
                    </div>
                    <div class="panel-body" id="ls-r-panel">
                        <div class="empty-state">Click Refresh to scan</div>
                    </div>
                </div>

                <div class="panel ls-top-picks" style="grid-column: 1 / -1;">
                    <div class="panel-header">
                        <span class="panel-title" style="color: var(--yellow, #f0c040);">Top Picks — Ranked by ATR%</span>
                        <span class="panel-count" id="ls-picks-count">0</span>
                    </div>
                    <div class="panel-body" id="ls-picks-panel">
                        <div class="empty-state">Click Refresh to scan</div>
                    </div>
                </div>

                <div class="ls-bottom-row">
                    <div class="panel ls-positions">
                        <div class="panel-header">
                            <span class="panel-title">Entered Signals</span>
                            <span class="panel-count" id="ls-positions-count">0</span>
                        </div>
                        <div class="panel-body" id="ls-positions-panel">
                            <div class="empty-state">No active positions</div>
                        </div>
                    </div>

                    <div class="panel ls-exits">
                        <div class="panel-header">
                            <span class="panel-title">Exit Signals</span>
                            <span class="panel-count" id="ls-exits-count">0</span>
                        </div>
                        <div class="panel-body" id="ls-exits-panel">
                            <div class="empty-state">No exit signals</div>
                        </div>
                    </div>

                    <div class="panel ls-closed-trades">
                        <div class="panel-header">
                            <span class="panel-title">Closed Trades</span>
                            <span class="panel-count" id="ls-closed-count">0</span>
                        </div>
                        <div class="panel-body" id="ls-closed-panel">
                            <div class="empty-state">No closed trades</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Batch Backtest Results -->
            <div class="batch-results hidden" id="batch-results">
                <div style="display:flex;align-items:center;gap:8px;">
                    <button class="btn btn-back" style="margin-bottom:0;" onclick="closeBatchBacktest()">&larr; Back</button>
                    <div class="batch-title" id="batch-title" style="flex:1;">Batch Backtest Results</div>
                    <button class="btn hidden" id="batch-download-btn" onclick="downloadBatchCSV()" style="width:auto;padding:5px 12px;">Download CSV</button>
                </div>
                <div class="batch-table-container" id="batch-table-container">
                    <div class="empty-state">Run batch backtest to see results</div>
                </div>
            </div>

            <!-- Backtest Results -->
            <div class="backtest-results hidden" id="backtest-results">
                <div style="display:flex;align-items:center;gap:8px;">
                    <button class="btn btn-back" style="margin-bottom:0;" onclick="closeBacktest()">&larr; Back</button>
                    <div style="flex:1;"></div>
                    <button class="btn hidden" id="portfolio-download-btn" onclick="downloadPortfolioCSV()" style="width:auto;padding:5px 12px;">Download CSV</button>
                </div>
                <div class="backtest-summary" id="backtest-summary"></div>
                <div class="backtest-trades-panel">
                    <div class="panel-header">
                        <span class="panel-title" id="backtest-title">Trade Log</span>
                        <span class="panel-count" id="backtest-trade-count">0</span>
                    </div>
                    <div class="panel-body" id="backtest-trades-body">
                        <div class="empty-state">Run a backtest to see results</div>
                    </div>
                </div>
            </div>

            <!-- Trade Explain Results -->
            <div class="trade-explain hidden" id="trade-explain-results">
                <div style="display:flex;align-items:center;gap:8px;">
                    <button class="btn btn-back" style="margin-bottom:0;" onclick="closeTradeExplain()">&larr; Back</button>
                    <div style="flex:1;"></div>
                </div>
                <div id="trade-explain-content">
                    <div class="empty-state">Select a stock, strategy, and entry date to explain a trade</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // State
        let kiteUsers = [];
        let selectedTradeUser = null;
        let autoRefreshInterval = null;
        let activeStrategy = 'rs';
        let liveSignalsDataLoaded = false;
        let lsScanDate = null;  // tracks selected historical date
        let batchResultData = null;
        let portfolioResultData = null;
        let portfolioSortCol = 'exit';  // default sort by exit date
        let portfolioSortDir = 'asc';
        const AUTO_REFRESH_MS = 15 * 60 * 1000;

        // Indian number formatting helpers
        function parseIndian(str) {
            return parseInt(String(str).replace(/,/g, ''), 10) || 0;
        }

        function toIndian(num) {
            num = parseInt(num, 10);
            if (isNaN(num)) return '';
            const s = num.toString();
            if (s.length <= 3) return s;
            let last3 = s.slice(-3);
            let rest = s.slice(0, -3);
            rest = rest.replace(/\B(?=(\d{2})+(?!\d))/g, ',');
            return rest + ',' + last3;
        }

        function formatIndian(el) {
            const pos = el.selectionStart;
            const oldLen = el.value.length;
            const raw = parseIndian(el.value);
            if (raw > 0) {
                el.value = toIndian(raw);
            }
            const newLen = el.value.length;
            el.setSelectionRange(pos + newLen - oldLen, pos + newLen - oldLen);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set default backtest date range (last 1 year)
            const today = new Date();
            const oneYearAgo = new Date(today);
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            document.getElementById('backtest-to').value = today.toISOString().split('T')[0];
            document.getElementById('backtest-from').value = oneYearAgo.toISOString().split('T')[0];

            // Init live signals date picker
            const lsDateInput = document.getElementById('ls-scan-date');
            lsDateInput.max = today.toISOString().split('T')[0];
            lsDateInput.addEventListener('change', onScanDateChange);

            loadSettings();
            checkConnection();
            loadData();
            loadPaperTradesCount();
            startAutoRefresh();

            window.addEventListener('message', (event) => {
                if (event.data.type === 'ZERODHA_LOGIN_SUCCESS') {
                    showToast('Connected to Zerodha!', 'success');
                    checkConnection();
                } else if (event.data.type === 'ZERODHA_LOGIN_FAILED') {
                    showToast('Login failed', 'error');
                }
            });
        });

        // ============ Strategy Switching ============

        function switchStrategy(strategy) {
            activeStrategy = strategy;

            // Update tabs
            const tabs = document.querySelectorAll('.strategy-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            if (strategy === 'rs') tabs[0].classList.add('active');
            else if (strategy === 'live_signals') tabs[1].classList.add('active');
            else if (strategy === 'momentum') tabs[2].classList.add('active');
            else if (strategy === 'trade_explain') tabs[3].classList.add('active');

            // Toggle panels
            document.getElementById('rs-panels').classList.toggle('hidden', strategy !== 'rs');
            document.getElementById('live-signals-panels').classList.toggle('hidden', strategy !== 'live_signals');
            document.getElementById('backtest-results').classList.add('hidden');
            document.getElementById('batch-results').classList.add('hidden');
            document.getElementById('trade-explain-results').classList.toggle('hidden', strategy !== 'trade_explain');

            // Toggle sidebar settings
            document.getElementById('rs-settings').classList.toggle('hidden', strategy !== 'rs');
            document.getElementById('live-signals-settings').classList.toggle('hidden', strategy !== 'live_signals');
            document.getElementById('momentum-settings').classList.toggle('hidden', strategy !== 'momentum');
            document.getElementById('trade-explain-settings').classList.toggle('hidden', strategy !== 'trade_explain');

            // Lazy-load data on first switch
            if (strategy === 'live_signals' && !liveSignalsDataLoaded) {
                loadLiveSignalsData();
                loadLivePositions();
                loadClosedTrades();
            }
        }

        // ============ Settings ============

        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('rs-period').value = data.settings.rs_period || 63;
                    document.getElementById('ema-period').value = data.settings.ema_period || 63;
                    document.getElementById('ls-universe').value = data.settings.live_signals_universe || 50;
                }
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        async function saveSettings() {
            const rsPeriod = parseInt(document.getElementById('rs-period').value);
            const emaPeriod = parseInt(document.getElementById('ema-period').value);
            const lsUniverse = parseInt(document.getElementById('ls-universe').value);
            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rs_period: rsPeriod,
                        ema_period: emaPeriod,
                        live_signals_universe: lsUniverse
                    })
                });
                const data = await res.json();

                if (data.success) {
                    showToast('Settings saved', 'success');
                    if (data.needs_refresh && activeStrategy === 'rs') {
                        refreshData();
                    }
                    if (data.needs_live_signals_refresh && activeStrategy === 'live_signals') {
                        refreshLiveSignalsData();
                    }
                } else {
                    showToast(data.error || 'Failed to save', 'error');
                }
            } catch (e) {
                showToast('Failed to save settings', 'error');
            }
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                if (activeStrategy === 'rs') loadData();
                else if (activeStrategy === 'live_signals') loadLiveSignalsData();
            }, AUTO_REFRESH_MS);
        }

        // ============ Connection ============

        async function checkConnection() {
            try {
                const res = await fetch('/api/users');
                const data = await res.json();
                if (data.success) {
                    kiteUsers = data.users;
                    updateConnectionUI();
                    loadUserMargins();
                }
            } catch (e) {
                console.error('Connection check failed:', e);
            }
        }

        async function loadUserMargins() {
            try {
                const res = await fetch('/api/live-signals/margins');
                const data = await res.json();
                if (data.success) {
                    if (data.margins) {
                        for (const [uid, m] of Object.entries(data.margins)) {
                            const el = document.getElementById(`margin-${uid}`);
                            if (el && m.available_cash > 0) {
                                const cashL = (m.available_cash / 100000).toFixed(1);
                                el.textContent = `Funds: ₹${m.available_cash.toLocaleString('en-IN')} (${cashL}L)`;
                            }
                        }
                    }
                }
            } catch (e) {
                console.error('Margins load error:', e);
            }
        }

        function updateConnectionUI() {
            // Header dots
            const headerStatus = document.getElementById('header-status');
            if (kiteUsers.length === 0) {
                headerStatus.innerHTML = '<span class="status-dot"></span><span>No users</span>';
            } else {
                const dots = kiteUsers.map(u => {
                    const cls = u.connected ? 'status-dot connected' : 'status-dot';
                    return `<span class="${cls}" title="${u.config_name}"></span>`;
                }).join('');
                const anyConnected = kiteUsers.some(u => u.connected);
                const label = anyConnected
                    ? kiteUsers.filter(u => u.connected).map(u => u.config_name).join(', ')
                    : 'Disconnected';
                headerStatus.innerHTML = dots + `<span>${label}</span>`;
            }

            // Sidebar user cards
            const container = document.getElementById('user-cards-container');
            container.innerHTML = kiteUsers.map(u => {
                const connClass = u.connected ? 'user-card connected' : 'user-card';
                const statusText = u.connected
                    ? (u.user_name ? `Connected as ${u.user_name}` : 'Connected')
                    : (u.api_key_configured ? 'Not connected' : 'API key missing');
                const dotClass = u.connected ? 'status-dot connected' : 'status-dot';

                let actions = '';
                if (u.connected) {
                    actions = `<button class="btn" onclick="disconnectUser('${u.config_user_id}')" style="font-size:10px;padding:3px 8px;">Disconnect</button>`;
                } else if (u.api_key_configured) {
                    actions = `
                        <button class="btn" onclick="handleLogin('${u.config_user_id}')" style="font-size:10px;padding:3px 8px;">Get Token</button>
                        <div class="token-row">
                            <input type="text" id="token-${u.config_user_id}" placeholder="Paste redirect URL">
                            <button class="btn btn-primary" onclick="submitToken('${u.config_user_id}')" style="font-size:10px;padding:3px 8px;">Go</button>
                        </div>`;
                }

                const marginLine = u.connected
                    ? `<div id="margin-${u.config_user_id}" style="font-size:11px;color:var(--green);margin-top:2px;"></div>`
                    : '';

                return `
                    <div class="${connClass}">
                        <div class="user-card-header">
                            <span class="${dotClass}"></span>
                            <span class="user-card-name">${u.config_name}</span>
                        </div>
                        <div class="user-card-status">${statusText}</div>
                        ${marginLine}
                        <div class="user-card-actions">${actions}</div>
                    </div>`;
            }).join('');

            // Trade-as selector
            const sel = document.getElementById('trade-as-select');
            const connectedUsers = kiteUsers.filter(u => u.connected);
            sel.innerHTML = connectedUsers.length === 0
                ? '<option value="">No connected users</option>'
                : connectedUsers.map(u =>
                    `<option value="${u.config_user_id}">${u.config_name}</option>`
                ).join('');

            // Preserve or set selectedTradeUser
            if (connectedUsers.length > 0) {
                if (!selectedTradeUser || !connectedUsers.find(u => u.config_user_id === selectedTradeUser)) {
                    selectedTradeUser = connectedUsers[0].config_user_id;
                }
                sel.value = selectedTradeUser;
            } else {
                selectedTradeUser = null;
            }

            sel.onchange = () => { selectedTradeUser = sel.value; };
        }

        async function handleLogin(userId) {
            try {
                const res = await fetch(`/api/login/url?user_id=${encodeURIComponent(userId)}`);
                const data = await res.json();

                if (data.success && data.url) {
                    window.open(data.url, 'Zerodha Login', 'width=600,height=600');
                } else {
                    showToast(data.error || 'Configure API key', 'error');
                }
            } catch (e) {
                showToast('Failed to get login URL', 'error');
            }
        }

        async function disconnectUser(userId) {
            try {
                const res = await fetch('/api/connection/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    checkConnection();
                } else {
                    showToast(data.error || 'Disconnect failed', 'error');
                }
            } catch (e) {
                showToast('Disconnect failed', 'error');
            }
        }

        async function submitToken(userId) {
            const inputEl = document.getElementById(`token-${userId}`);
            const input = inputEl ? inputEl.value.trim() : '';
            if (!input) {
                showToast('Please paste the redirect URL', 'error');
                return;
            }

            let token = input;
            if (input.includes('request_token=')) {
                const match = input.match(/request_token=([^&]+)/);
                token = match ? match[1] : input;
            }

            try {
                const res = await fetch('/api/login/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_token: token, user_id: userId })
                });
                const data = await res.json();

                if (data.success) {
                    showToast(data.message || 'Connected!', 'success');
                    checkConnection();
                    if (inputEl) inputEl.value = '';
                } else {
                    showToast(data.error || 'Connection failed', 'error');
                }
            } catch (e) {
                showToast('Connection failed', 'error');
            }
        }

        // ============ RS Screener Data ============

        async function loadData() {
            try {
                const res = await fetch('/api/screener/data');
                const data = await res.json();

                if (data.success) {
                    renderPanels(data.data);
                    updateStats(data.data);
                    updateLastUpdated(data.data.last_updated, data.cache_age_minutes);
                } else {
                    showError(data.error || 'Unknown error');
                }
            } catch (e) {
                console.error('Load error:', e);
                showError('Failed to load data');
            }
        }

        async function refreshData() {
            if (activeStrategy === 'live_signals') {
                refreshLiveSignalsData();
                return;
            }
            if (activeStrategy === 'momentum') {
                return;
            }

            const btn = document.getElementById('refresh-btn');
            btn.classList.add('loading');
            btn.disabled = true;

            ['sectoral-panel', 'nifty50-panel', 'nifty100-panel', 'midcap150-panel'].forEach(id => {
                document.getElementById(id).innerHTML = `
                    <div class="loading-container">
                        <div class="loader"></div>
                        <span>Refreshing...</span>
                        <span class="progress-text" id="${id}-progress"></span>
                    </div>
                `;
            });

            const progressInterval = setInterval(async () => {
                try {
                    const res = await fetch('/api/screener/progress');
                    const progress = await res.json();
                    if (progress.in_progress && progress.total > 0) {
                        const pct = Math.round((progress.current / progress.total) * 100);
                        const text = `${progress.current}/${progress.total} (${pct}%)`;
                        document.querySelectorAll('#rs-panels .progress-text').forEach(el => {
                            el.textContent = text;
                        });
                    }
                } catch (e) {}
            }, 500);

            try {
                const res = await fetch('/api/screener/refresh', { method: 'POST' });
                const data = await res.json();
                clearInterval(progressInterval);

                if (data.success) {
                    renderPanels(data.data);
                    updateStats(data.data);
                    updateLastUpdated(data.data.last_updated, 0);
                    showToast('Data refreshed!', 'success');
                } else {
                    showToast(data.error || 'Refresh failed', 'error');
                    loadData();
                }
            } catch (e) {
                clearInterval(progressInterval);
                showToast('Refresh failed', 'error');
                loadData();
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        function renderPanels(data) {
            renderStockTable('sectoral-panel', data.sectoral_indices);
            renderStockTable('nifty50-panel', data.nifty50);
            renderStockTable('nifty100-panel', data.nifty100);
            renderStockTable('midcap150-panel', data.midcap150);

            document.getElementById('sectoral-count').textContent = data.sectoral_indices?.length || 0;
            document.getElementById('nifty50-count').textContent = data.nifty50?.length || 0;
            document.getElementById('nifty100-count').textContent = data.nifty100?.length || 0;
            document.getElementById('midcap150-count').textContent = data.midcap150?.length || 0;
        }

        // Track sort state per panel: { field, dir }
        const panelSortState = {};

        function renderStockTable(panelId, stocks) {
            const panel = document.getElementById(panelId);

            if (!stocks || stocks.length === 0) {
                panel.innerHTML = '<div class="empty-state">No stocks</div>';
                return;
            }

            // Store raw data on the panel for re-sorting
            panel._stockData = stocks;

            // Apply current sort if any
            const sort = panelSortState[panelId];
            const sorted = [...stocks];
            if (sort) {
                sorted.sort((a, b) => sort.dir === 'asc'
                    ? a[sort.field] - b[sort.field]
                    : b[sort.field] - a[sort.field]);
            }

            _renderSortedTable(panel, panelId, sorted, sort);
        }

        function _renderSortedTable(panel, panelId, sorted, sort) {
            const rows = sorted.map(stock => {
                const rsClass = stock.rs >= 0 ? 'positive' : 'negative';
                const emaClass = stock.price_vs_ema >= 0 ? 'positive' : 'negative';
                const chgClass = stock.pct_change >= 0 ? 'positive' : 'negative';

                return `
                    <tr>
                        <td class="ticker">${stock.ticker}</td>
                        <td class="price">${stock.price.toLocaleString()}</td>
                        <td class="ema-pct ${chgClass}">${stock.pct_change >= 0 ? '+' : ''}${stock.pct_change.toFixed(1)}%</td>
                        <td class="rs-value ${rsClass}">${stock.rs >= 0 ? '+' : ''}${stock.rs.toFixed(1)}</td>
                        <td class="ema-pct ${emaClass}">${stock.price_vs_ema >= 0 ? '+' : ''}${stock.price_vs_ema.toFixed(1)}%</td>
                    </tr>
                `;
            }).join('');

            const sortCols = [
                { label: '%Chg', field: 'pct_change' },
                { label: 'RS', field: 'rs' },
                { label: 'vs EMA', field: 'price_vs_ema' },
            ];

            const thSortable = sortCols.map(col => {
                let cls = 'sortable';
                if (sort && sort.field === col.field) cls += ' ' + sort.dir;
                return `<th class="${cls}" data-field="${col.field}">${col.label}</th>`;
            }).join('');

            panel.innerHTML = `
                <table class="stock-table">
                    <thead>
                        <tr><th>Name</th><th>Price</th>${thSortable}</tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;

            // Attach click handlers for sortable headers
            panel.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const field = th.dataset.field;
                    const prev = panelSortState[panelId];
                    if (prev && prev.field === field) {
                        // Toggle: desc -> asc -> clear
                        if (prev.dir === 'desc') panelSortState[panelId] = { field, dir: 'asc' };
                        else delete panelSortState[panelId];
                    } else {
                        panelSortState[panelId] = { field, dir: 'desc' };
                    }
                    renderStockTable(panelId, panel._stockData);
                });
            });
        }

        function updateStats(data) {
            document.getElementById('stocks-processed').textContent = data.stats?.total_processed || '--';

            const niftyEl = document.getElementById('nifty-return');
            const niftyVal = data.nifty50_return;
            if (niftyVal !== undefined && niftyVal !== null) {
                niftyEl.textContent = (niftyVal >= 0 ? '+' : '') + niftyVal.toFixed(2) + '%';
                niftyEl.style.color = niftyVal >= 0 ? 'var(--green)' : 'var(--red)';
            }
        }

        function updateLastUpdated(timestamp, cacheAge) {
            const date = new Date(timestamp);
            const timeStr = date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
            const ageStr = cacheAge !== null ? ` (${Math.round(cacheAge)}m ago)` : '';
            document.getElementById('last-updated').textContent = `Updated: ${timeStr}${ageStr}`;
        }

        function showError(message) {
            ['sectoral-panel', 'nifty50-panel', 'nifty100-panel', 'midcap150-panel'].forEach(id => {
                document.getElementById(id).innerHTML = `
                    <div class="empty-state" style="color: var(--red);">Error: ${message}</div>
                `;
            });
        }

        // ============ Live Signals Data ============

        async function loadLiveSignalsData() {
            try {
                const res = await fetch('/api/live-signals/data');
                const data = await res.json();

                if (data.success) {
                    renderEntrySignals(data.data);
                    updateLastUpdated(data.data.last_updated, data.cache_age_minutes);
                    liveSignalsDataLoaded = true;
                } else {
                    showLiveSignalsError(data.error || 'Unknown error');
                }
            } catch (e) {
                console.error('Live Signals load error:', e);
                showLiveSignalsError('Click Refresh to scan for signals.');
            }
        }

        async function refreshLiveSignalsData() {
            if (isHistoricalScan()) {
                return scanForDate(lsScanDate);
            }

            const btn = document.getElementById('refresh-btn');
            btn.classList.add('loading');
            btn.disabled = true;

            ['ls-j-panel', 'ls-t-panel', 'ls-r-panel', 'ls-picks-panel'].forEach(id => {
                document.getElementById(id).innerHTML = `
                    <div class="loading-container">
                        <div class="loader"></div>
                        <span>Scanning...</span>
                        <span class="progress-text"></span>
                    </div>
                `;
            });

            const progressInterval = setInterval(async () => {
                try {
                    const res = await fetch('/api/live-signals/progress');
                    const progress = await res.json();
                    if (progress.in_progress && progress.total > 0) {
                        const pct = Math.round((progress.current / progress.total) * 100);
                        const text = `${progress.current}/${progress.total} (${pct}%)`;
                        document.querySelectorAll('#live-signals-panels .progress-text').forEach(el => {
                            el.textContent = text;
                        });
                    }
                } catch (e) {}
            }, 500);

            try {
                const res = await fetch('/api/live-signals/refresh', { method: 'POST' });
                const data = await res.json();
                clearInterval(progressInterval);

                if (data.success) {
                    renderEntrySignals(data.data);
                    updateLastUpdated(data.data.last_updated, 0);
                    liveSignalsDataLoaded = true;
                    showToast('Live signals refreshed!', 'success');
                    // Also refresh positions (LTP/P&L) and exits
                    loadLivePositions();
                    loadExitSignals();
                } else {
                    showToast(data.error || 'Refresh failed', 'error');
                    loadLiveSignalsData();
                }
            } catch (e) {
                clearInterval(progressInterval);
                showToast('Refresh failed', 'error');
                loadLiveSignalsData();
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        function isHistoricalScan() { return lsScanDate !== null; }

        function onScanDateChange() {
            const val = document.getElementById('ls-scan-date').value;
            if (val) {
                lsScanDate = val;
                document.getElementById('ls-historical-info').classList.remove('hidden');
                scanForDate(val);
            } else {
                clearScanDate();
            }
        }

        function clearScanDate() {
            lsScanDate = null;
            document.getElementById('ls-scan-date').value = '';
            document.getElementById('ls-historical-info').classList.add('hidden');
            // Reload today's cached data
            loadLiveSignalsData();
        }

        async function scanForDate(dateStr) {
            const btn = document.getElementById('refresh-btn');
            btn.classList.add('loading');
            btn.disabled = true;

            ['ls-j-panel', 'ls-t-panel', 'ls-r-panel', 'ls-picks-panel'].forEach(id => {
                document.getElementById(id).innerHTML = `
                    <div class="loading-container">
                        <div class="loader"></div>
                        <span>Scanning ${dateStr}...</span>
                        <span class="progress-text"></span>
                    </div>
                `;
            });

            const progressInterval = setInterval(async () => {
                try {
                    const res = await fetch('/api/live-signals/progress');
                    const progress = await res.json();
                    if (progress.in_progress && progress.total > 0) {
                        const pct = Math.round((progress.current / progress.total) * 100);
                        const text = `${progress.current}/${progress.total} (${pct}%)`;
                        document.querySelectorAll('#live-signals-panels .progress-text').forEach(el => {
                            el.textContent = text;
                        });
                    }
                } catch (e) {}
            }, 500);

            try {
                const res = await fetch('/api/live-signals/scan-date', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({scan_date: dateStr}),
                });
                const data = await res.json();
                clearInterval(progressInterval);

                if (data.success) {
                    renderEntrySignals(data.data, true);
                    const actualDate = data.data.actual_date || dateStr;
                    const displayDate = actualDate !== dateStr ? `${actualDate} (trading day for ${dateStr})` : dateStr;
                    document.getElementById('last-updated').textContent = `Signals for: ${displayDate}`;
                    showToast(`Signals loaded for ${actualDate}`, 'success');
                } else {
                    showToast(data.error || 'Scan failed', 'error');
                }
            } catch (e) {
                clearInterval(progressInterval);
                showToast('Historical scan failed', 'error');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        function renderEntrySignals(data, isHistorical) {
            isHistorical = isHistorical || false;
            // J signals
            const jPanel = document.getElementById('ls-j-panel');
            const jSignals = data.j_signals || [];
            document.getElementById('ls-j-count').textContent = jSignals.length;

            if (jSignals.length === 0) {
                jPanel.innerHTML = '<div class="empty-state">No J signals</div>';
            } else {
                const rows = jSignals.map(s => `
                    <tr>
                        <td class="ticker">${s.ticker}</td>
                        <td class="price">${s.price.toLocaleString()}</td>
                        <td class="price">${s.support.toLocaleString()}</td>
                        <td>${s.close_near_pct.toFixed(1)}%</td>
                        <td class="rs-value positive">${s.ibs.toFixed(2)}</td>
                        <td style="color:${(s.stop_pct||0)<5?'var(--green)':'var(--red)'}">${(s.stop_pct||0).toFixed(1)}%</td>
                    </tr>
                `).join('');
                jPanel.innerHTML = `
                    <table class="stock-table">
                        <thead><tr><th>Stock</th><th>Close</th><th>Supp</th><th>Dist%</th><th>IBS</th><th>Stop%</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            }

            // T signals
            const tPanel = document.getElementById('ls-t-panel');
            const tSignals = data.t_signals || [];
            document.getElementById('ls-t-count').textContent = tSignals.length;

            if (tSignals.length === 0) {
                tPanel.innerHTML = '<div class="empty-state">No T signals</div>';
            } else {
                const rows = tSignals.map(s => `
                    <tr>
                        <td class="ticker">${s.ticker}</td>
                        <td class="price">${s.price.toLocaleString()}</td>
                        <td class="price">${s.ema20.toLocaleString()}</td>
                        <td class="price">${s.upper_keltner.toLocaleString()}</td>
                        <td style="color:var(--text-muted)">${(s.stop_pct||5).toFixed(1)}%</td>
                    </tr>
                `).join('');
                tPanel.innerHTML = `
                    <table class="stock-table">
                        <thead><tr><th>Stock</th><th>Close</th><th>EMA20</th><th>UpKelt</th><th>Stop%</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            }

            // R signals
            const rPanel = document.getElementById('ls-r-panel');
            const rSignals = data.r_signals || [];
            document.getElementById('ls-r-count').textContent = rSignals.length;

            if (rSignals.length === 0) {
                rPanel.innerHTML = '<div class="empty-state">No R signals</div>';
            } else {
                const rows = rSignals.map(s => `
                    <tr>
                        <td class="ticker">${s.ticker}</td>
                        <td class="price">${s.price.toLocaleString()}</td>
                        <td>${(s.rsi14||0).toFixed(1)} <span style="color:var(--green);font-size:11px;">(${(s.rsi_at_low||0).toFixed(1)})</span></td>
                        <td class="price">${(s.swing_low||0).toLocaleString()}</td>
                        <td class="price">${(s.stop||0).toLocaleString()}</td>
                        <td style="color:${(s.stop_pct||0)<5?'var(--green)':'var(--red)'}">${(s.stop_pct||0).toFixed(1)}%</td>
                    </tr>
                `).join('');
                rPanel.innerHTML = `
                    <table class="stock-table">
                        <thead><tr><th>Stock</th><th>Close</th><th>RSI14 (Low)</th><th>SwLow</th><th>Stop</th><th>Stop%</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            }

            // Top Picks — combine J+T+R, rank by ATR% (lowest volatility first)
            const picksPanel = document.getElementById('ls-picks-panel');
            const allSignals = [
                ...jSignals.map(s => ({...s, strategy: 'J', stop_pct: s.stop_pct || 99, atr_pct: s.atr_pct || 99})),
                ...tSignals.map(s => ({...s, strategy: 'T', stop_pct: s.stop_pct || 5.0, atr_pct: s.atr_pct || 99})),
                ...rSignals.map(s => ({...s, strategy: 'R', stop_pct: s.stop_pct || 99, atr_pct: s.atr_pct || 99})),
            ].sort((a, b) => a.atr_pct - b.atr_pct);
            document.getElementById('ls-picks-count').textContent = allSignals.length;

            if (allSignals.length === 0) {
                picksPanel.innerHTML = '<div class="empty-state">No signals</div>';
            } else {
                const rows = allSignals.map((s, idx) => {
                    const isTop2 = idx < 2;
                    const rowStyle = isTop2 ? 'background:rgba(76,175,80,0.12);font-weight:600;' : '';
                    const rank = idx + 1;
                    const badgeMap = {
                        'J': '<span style="color:var(--green);font-weight:700;">J</span>',
                        'T': '<span style="color:var(--blue);font-weight:700;">T</span>',
                        'R': '<span style="color:#ab47bc;font-weight:700;">R</span>',
                    };
                    const badge = badgeMap[s.strategy] || s.strategy;
                    const stopColor = s.stop_pct < 5 ? 'var(--green)' : s.stop_pct === 5 ? 'var(--text-muted)' : 'var(--red)';
                    const detail = s.strategy === 'J'
                        ? `Supp ${s.support.toLocaleString()} | IBS ${s.ibs.toFixed(2)}`
                        : s.strategy === 'R'
                        ? `RSI14 ${(s.rsi14||0).toFixed(1)} (${(s.rsi_at_low||0).toFixed(1)}) | SwLow ${(s.swing_low||0).toLocaleString()}`
                        : `EMA20 ${s.ema20.toLocaleString()}`;
                    const stopVal = s.strategy === 'J' ? s.stop : s.strategy === 'R' ? s.stop : Math.round(s.price * 0.95);
                    const ibsVal = s.strategy === 'J' ? s.ibs : 0;
                    const atrColor = s.atr_pct < 2 ? 'var(--green)' : s.atr_pct < 3.5 ? 'var(--text-muted)' : 'var(--red)';
                    return `
                        <tr style="${rowStyle}">
                            <td>${isTop2 ? '&#9733;' : rank}</td>
                            <td>${badge}</td>
                            <td class="ticker">${s.ticker}</td>
                            <td class="price">${s.price.toLocaleString()}</td>
                            <td style="color:${atrColor};font-weight:600;">${s.atr_pct.toFixed(1)}%</td>
                            <td style="color:${stopColor};">${s.stop_pct.toFixed(1)}%</td>
                            <td class="price">${stopVal.toLocaleString()}</td>
                            <td style="font-size:11px;color:var(--text-muted);">${detail}</td>
                            ${isHistorical ? '' : `<td style="white-space:nowrap;">
                                <span style="font-size:11px;">&#8377;</span><input type="text" class="buy-input" id="amt-pick-${s.ticker}" value="1,00,000" oninput="formatIndian(this)" onfocus="this.select()">
                                <button class="trade-btn" onclick="buyLiveSignal('${s.ticker}', '${s.strategy}', ${s.price}, ${stopVal}, ${ibsVal}, this)">Buy</button>
                            </td>`}
                        </tr>`;
                }).join('');
                picksPanel.innerHTML = `
                    <table class="stock-table">
                        <thead><tr><th>#</th><th>Str</th><th>Stock</th><th>Close</th><th>ATR%</th><th>Stop%</th><th>Stop</th><th>Detail</th>${isHistorical ? '' : '<th></th>'}</tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            }


        }

        async function buyLiveSignal(ticker, strategy, price, support, ibs, btn) {
            if (!selectedTradeUser) {
                showToast('Select a connected user to trade as', 'error');
                return;
            }

            const amtInput = btn.parentElement.querySelector('.buy-input');
            const amount = amtInput ? parseIndian(amtInput.value) : 100000;

            btn.disabled = true;
            btn.textContent = '...';

            try {
                const res = await fetch('/api/live-signals/buy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ticker, strategy, price, amount, support, ibs,
                        user_id: selectedTradeUser,
                        metadata: { nifty_at_entry: 0 }
                    })
                });
                const data = await res.json();
                if (data.success) {
                    const userName = (kiteUsers.find(u => u.config_user_id === selectedTradeUser) || {}).config_name || selectedTradeUser;
                    showToast(`Bought ${data.position.shares} shares of ${ticker} [${userName}]`, 'success');
                    loadLivePositions();
                } else {
                    showToast(data.error || 'Buy failed', 'error');
                }
            } catch (e) {
                showToast('Buy failed', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Buy';
            }
        }

        async function loadClosedTrades() {
            try {
                const res = await fetch('/api/live-signals/closed');
                const data = await res.json();
                const panel = document.getElementById('ls-closed-panel');
                const closed = data.closed || [];
                document.getElementById('ls-closed-count').textContent = closed.length;
                if (closed.length === 0) {
                    panel.innerHTML = '<div class="empty-state">No closed trades</div>';
                } else {
                    const fmt = (n) => Number(n).toLocaleString('en-IN', {maximumFractionDigits: 0});
                    // Summary
                    let totalPnl = 0;
                    let wins = 0;
                    let losses = 0;
                    closed.forEach(c => {
                        const amt = c.pnl_amount || 0;
                        totalPnl += amt;
                        if (amt >= 0) wins++; else losses++;
                    });
                    const totalClass = totalPnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                    const totalSign = totalPnl >= 0 ? '+' : '';

                    const rows = closed.map(c => {
                        const pnlClass = c.pnl_pct >= 0 ? 'positive' : 'negative';
                        const amtClass = (c.pnl_amount || 0) >= 0 ? 'pnl-positive' : 'pnl-negative';
                        const amtSign = (c.pnl_amount || 0) >= 0 ? '+' : '';
                        const shares = c.shares_exited || '';
                        return `<tr>
                            <td class="ticker">${c.ticker}</td>
                            <td>${c.strategy}</td>
                            <td class="price">${c.entry_price}</td>
                            <td class="price">${c.exit_price}</td>
                            <td style="text-align:right">${shares}</td>
                            <td class="rs-value ${pnlClass}">${c.pnl_pct >= 0 ? '+' : ''}${c.pnl_pct}%</td>
                            <td class="${amtClass}" style="text-align:right">${amtSign}${fmt(c.pnl_amount || 0)}</td>
                            <td>${c.reason}</td>
                            <td>${c.exit_date}</td>
                            <td style="text-align:right">${c.holding_days != null ? c.holding_days + 'd' : ''}</td>
                        </tr>`;
                    }).join('');
                    panel.innerHTML = `
                        <div style="display:flex;gap:12px;padding:6px 10px;font-size:11px;border-bottom:1px solid var(--border-color);align-items:center;">
                            <span style="color:var(--text-muted);">Total P&L:</span>
                            <span class="${totalClass}" style="font-weight:600;font-size:13px;">${totalSign}&#8377;${fmt(Math.abs(totalPnl))}</span>
                            <span style="color:var(--text-muted);margin-left:8px;">W: ${wins} / L: ${losses}</span>
                            <span style="color:var(--text-muted);">WR: ${closed.length > 0 ? Math.round(wins / closed.length * 100) : 0}%</span>
                        </div>
                        <table class="stock-table">
                            <thead><tr><th>Stock</th><th>Strat</th><th>Entry</th><th>Exit</th><th>Shares</th><th>P&L%</th><th>P&L &#8377;</th><th>Reason</th><th>Date</th><th>Hold</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    `;
                }
            } catch (e) {
                console.error('Load closed trades error:', e);
            }
        }

        async function loadLivePositions() {
            try {
                const res = await fetch('/api/live-signals/positions');
                const data = await res.json();
                if (data.success) {
                    renderPositions(data.positions, data.ltps || {});
                }
            } catch (e) {
                console.error('Positions load error:', e);
            }
        }

        function renderPositions(positions, ltps) {
            const panel = document.getElementById('ls-positions-panel');
            document.getElementById('ls-positions-count').textContent = positions.length;
            ltps = ltps || {};

            if (!positions || positions.length === 0) {
                panel.innerHTML = '<div class="empty-state">No active positions</div>';
                return;
            }

            const rows = positions.map(p => {
                const userName = p.user_id
                    ? ((kiteUsers.find(u => u.config_user_id === p.user_id) || {}).config_name || p.user_id)
                    : '';
                const ep = p.entry_price;
                const stage = p.partial_stage || 0;

                // Strategy-specific SL, targets, stage label
                let sl, t1, t2, stageLabel;
                if (p.strategy === 'J') {
                    sl = p.support_level || 0;
                    t1 = Math.round(ep * 1.05);
                    t2 = Math.round(ep * 1.10);
                    if (p.partial_exit_done) {
                        stageLabel = '<span style="color:var(--yellow);">Half out</span>';
                    } else {
                        stageLabel = '<span style="color:var(--text-muted);">Full pos</span>';
                    }
                } else if (p.strategy === 'R') {
                    // R: structural SL → 3-stage like T
                    sl = (p.metadata || {}).r_swing_low_stop || Math.round(ep * 0.99);
                    t1 = Math.round(ep * 1.06);
                    t2 = Math.round(ep * 1.10);
                    const stageLabels = [
                        '<span style="color:var(--text-muted);">Stage 0</span>',
                        '<span style="color:var(--yellow);">Stage 1 (1/3 out)</span>',
                        '<span style="color:var(--green);">Stage 2 (2/3 out)</span>',
                    ];
                    stageLabel = stageLabels[Math.min(stage, 2)];
                } else {
                    // T: 3-stage
                    sl = Math.round(ep * 0.95);
                    t1 = Math.round(ep * 1.06);
                    t2 = Math.round(ep * 1.10);
                    const stageLabels = [
                        '<span style="color:var(--text-muted);">Stage 0</span>',
                        '<span style="color:var(--yellow);">Stage 1 (1/3 out)</span>',
                        '<span style="color:var(--green);">Stage 2 (2/3 out)</span>',
                    ];
                    stageLabel = stageLabels[Math.min(stage, 2)];
                }
                const slPct = ((ep - sl) / ep * 100).toFixed(1);

                // LTP & P&L
                const ltp = ltps[p.ticker];
                let ltpCell, pnlCell;
                if (ltp) {
                    const pnlPct = ((ltp - ep) / ep * 100).toFixed(1);
                    const pnlColor = pnlPct >= 0 ? 'var(--green)' : 'var(--red)';
                    const pnlSign = pnlPct >= 0 ? '+' : '';
                    ltpCell = `<td class="price" style="font-weight:600;">${ltp.toLocaleString()}</td>`;
                    pnlCell = `<td style="color:${pnlColor};font-weight:600;">${pnlSign}${pnlPct}%</td>`;
                } else {
                    ltpCell = '<td style="color:var(--text-muted);">--</td>';
                    pnlCell = '<td>--</td>';
                }

                return `
                <tr>
                    <td class="ticker">${p.ticker}</td>
                    <td>${p.strategy === 'J'
                        ? '<span style="color:var(--green);font-weight:700;">J</span>'
                        : p.strategy === 'R'
                        ? '<span style="color:#ab47bc;font-weight:700;">R</span>'
                        : '<span style="color:var(--blue);font-weight:700;">T</span>'}</td>
                    <td style="font-size:10px;color:var(--text-muted);">${userName}</td>
                    <td>${p.entry_date}</td>
                    <td class="price">${ep.toLocaleString()}</td>
                    ${ltpCell}
                    ${pnlCell}
                    <td style="color:var(--red);">${sl.toLocaleString()} <span style="font-size:10px;">(${slPct}%)</span></td>
                    <td class="price">${t1.toLocaleString()}</td>
                    <td class="price">${t2.toLocaleString()}</td>
                    <td>${stageLabel}</td>
                    <td>${p.remaining_shares}/${p.shares}</td>
                    <td><button class="trade-btn" style="background:var(--red);color:#fff;padding:2px 7px;" onclick="forceExitPosition('${p.id}', this)" title="Sell on Zerodha & remove">Exit</button></td>
                </tr>`;
            }).join('');

            panel.innerHTML = `
                <table class="stock-table">
                    <thead><tr><th>Stock</th><th>Str</th><th>User</th><th>Entry</th><th>Price</th><th>LTP</th><th>P&L</th><th>SL</th><th>T1</th><th>T2</th><th>Stage</th><th>Shares</th><th></th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function forceExitPosition(posId, btn) {
            if (btn.dataset.confirm === 'yes') {
                // Second click — sell on Zerodha & remove
                btn.disabled = true;
                btn.textContent = '...';
                fetch('/api/live-signals/force-exit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ position_id: posId })
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        showToast(data.message, 'success');
                        loadLivePositions();
                        loadExitSignals();
                        loadClosedTrades();
                    } else {
                        showToast(data.error || 'Exit failed', 'error');
                        btn.disabled = false;
                        btn.textContent = 'Exit';
                        btn.dataset.confirm = '';
                        btn.style.background = 'var(--red)';
                    }
                }).catch(() => {
                    showToast('Exit failed', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Exit';
                    btn.dataset.confirm = '';
                    btn.style.background = 'var(--red)';
                });
            } else {
                // First click — ask for confirmation
                btn.dataset.confirm = 'yes';
                btn.textContent = 'Sure?';
                btn.style.background = '#c0392b';
                setTimeout(() => {
                    if (btn.dataset.confirm === 'yes') {
                        btn.textContent = 'Exit';
                        btn.dataset.confirm = '';
                        btn.style.background = 'var(--red)';
                    }
                }, 3000);
            }
        }

        async function loadExitSignals() {
            try {
                const res = await fetch('/api/live-signals/exits');
                const data = await res.json();
                if (data.success) {
                    renderExitSignals(data.exits);
                }
            } catch (e) {
                console.error('Exit signals load error:', e);
            }
        }

        function renderExitSignals(exits) {
            const panel = document.getElementById('ls-exits-panel');
            document.getElementById('ls-exits-count').textContent = exits.length;

            if (!exits || exits.length === 0) {
                panel.innerHTML = '<div class="empty-state">No exit signals</div>';
                return;
            }

            const rows = exits.map(e => {
                const pnlClass = e.pnl_pct >= 0 ? 'positive' : 'negative';
                const pnlSign = e.pnl_pct >= 0 ? '+' : '';
                return `
                    <tr>
                        <td class="ticker">${e.ticker}</td>
                        <td>${e.strategy}</td>
                        <td>${e.reason}</td>
                        <td class="rs-value ${pnlClass}">${pnlSign}${e.pnl_pct.toFixed(1)}%</td>
                        <td>${e.shares_to_exit}</td>
                        <td><button class="trade-btn" onclick="executeExit('${e.position_id}', ${e.current_price}, '${e.reason}', ${e.shares_to_exit}, this)">Exit</button></td>
                    </tr>
                `;
            }).join('');

            panel.innerHTML = `
                <table class="stock-table">
                    <thead><tr><th>Stock</th><th>Strat</th><th>Reason</th><th>P&L%</th><th>Shares</th><th></th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        async function executeExit(posId, price, reason, shares, btn) {
            btn.disabled = true;
            btn.textContent = '...';

            try {
                const res = await fetch('/api/live-signals/execute-exit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        position_id: posId,
                        exit_price: price,
                        reason: reason,
                        shares: shares
                    })
                });
                const data = await res.json();
                if (data.success) {
                    const pnl = data.closed.pnl_pct >= 0 ? `+${data.closed.pnl_pct}%` : `${data.closed.pnl_pct}%`;
                    showToast(`Exited ${data.closed.ticker}: ${pnl}`, data.closed.pnl_pct >= 0 ? 'success' : 'error');
                    loadLivePositions();
                    loadExitSignals();
                    loadClosedTrades();
                } else {
                    showToast(data.error || 'Exit failed', 'error');
                }
            } catch (e) {
                showToast('Exit failed', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Exit';
            }
        }

        function showLiveSignalsError(message) {
            ['ls-j-panel', 'ls-t-panel', 'ls-r-panel', 'ls-picks-panel'].forEach(id => {
                document.getElementById(id).innerHTML = `
                    <div class="empty-state" style="color: var(--text-muted);">${message}</div>
                `;
            });
        }

        // ============ Backtest ============


        async function runBacktest() {
            const symbol = document.getElementById('backtest-symbol').value;
            const fromDate = document.getElementById('backtest-from').value;
            const toDate = document.getElementById('backtest-to').value;
            let rawStrategy = document.getElementById('backtest-strategy').value;
            let strategy = rawStrategy;
            let exitEma = null;
            // Parse compound values like "J_close"
            if (rawStrategy.includes('_')) {
                const parts = rawStrategy.split('_');
                strategy = parts[0];
                exitEma = parts[1];
            }


            if (!symbol) {
                showToast('Please select a symbol', 'error');
                return;
            }

            const btn = document.getElementById('run-backtest-btn');
            btn.classList.add('loading');
            btn.disabled = true;
            btn.textContent = 'Running...';

            // Show backtest results area with loading state
                        document.getElementById('backtest-results').classList.remove('hidden');
            document.getElementById('backtest-summary').innerHTML = '';
            const loadingMsg = `Running Strategy ${strategy} backtest for ${symbol}...`;
            document.getElementById('backtest-trades-body').innerHTML = `
                <div class="loading-container">
                    <div class="loader"></div>
                    <span>${loadingMsg}</span>
                </div>
            `;

            try {
                const payload = { symbol: symbol, from_date: fromDate, to_date: toDate, strategy: strategy, exit_ema: exitEma };
                const res = await fetch('/api/momentum/backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.success) {
                    renderBacktestResults(data.data);
                    showToast(`Backtest complete: ${data.data.trades.length} trades`, 'success');
                } else {
                    document.getElementById('backtest-trades-body').innerHTML = `
                        <div class="empty-state" style="color: var(--red);">${data.error || 'Backtest failed'}</div>
                    `;
                    showToast(data.error || 'Backtest failed', 'error');
                }
            } catch (e) {
                document.getElementById('backtest-trades-body').innerHTML = `
                    <div class="empty-state" style="color: var(--red);">Backtest request failed</div>
                `;
                showToast('Backtest failed', 'error');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.textContent = 'Run Backtest';
            }
        }

        function renderBacktestResults(data) {
            portfolioResultData = null;
            document.getElementById('portfolio-download-btn').classList.add('hidden');
            const s = data.summary;
            const periodLabel = document.getElementById('backtest-from').value + ' to ' + document.getElementById('backtest-to').value;
            let stratLabel;
            const stratLabels = {'J': 'Strategy J (weekly support)', 'T': 'Strategy T (Keltner)'};
            stratLabel = stratLabels[data.strategy] || data.strategy;

            // Title
            document.getElementById('backtest-title').textContent = `${data.symbol} — ${stratLabel} — ${periodLabel} (${data.start_date} to ${data.end_date})`;
            document.getElementById('backtest-trade-count').textContent = `${s.total_trades} trades`;

            // Summary cards
            const pnlClass = s.total_pnl >= 0 ? 'positive' : 'negative';
            const pnlSign = s.total_pnl >= 0 ? '+' : '';
            const retSign = s.total_return_pct >= 0 ? '+' : '';

            document.getElementById('backtest-summary').innerHTML = `
                <div class="summary-card">
                    <div class="label">Total P&L</div>
                    <div class="value ${pnlClass}">${pnlSign}${s.total_pnl.toLocaleString()}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Return</div>
                    <div class="value ${pnlClass}">${retSign}${s.total_return_pct}%</div>
                </div>
                <div class="summary-card">
                    <div class="label">Win Rate</div>
                    <div class="value">${s.win_rate}%</div>
                </div>
                <div class="summary-card">
                    <div class="label">Profit Factor</div>
                    <div class="value">${s.profit_factor}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Total Trades</div>
                    <div class="value">${s.total_trades}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Avg Win</div>
                    <div class="value positive">+${s.avg_win.toLocaleString()}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Avg Loss</div>
                    <div class="value negative">${s.avg_loss.toLocaleString()}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Avg Hold Days</div>
                    <div class="value">${s.avg_holding_days}</div>
                </div>
            `;

            // Trade log table
            if (!data.trades || data.trades.length === 0) {
                document.getElementById('backtest-trades-body').innerHTML = '<div class="empty-state">No trades in this period</div>';
                return;
            }

            const isRotation = false;
            const rows = data.trades.map((t, i) => {
                const pnlCls = t.pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                const pnlSign = t.pnl >= 0 ? '+' : '';
                return `
                    <tr>
                        <td>${i + 1}</td>
                        ${isRotation ? `<td><strong>${t.ticker}</strong></td>` : ''}
                        <td>${t.entry_date}</td>
                        <td>${t.entry_time}</td>
                        <td class="price">${t.entry_price.toLocaleString()}</td>
                        <td>${t.shares}</td>
                        <td>${t.exit_date}</td>
                        <td>${t.exit_time}</td>
                        <td class="price">${t.exit_price.toLocaleString()}</td>
                        <td class="${pnlCls}">${pnlSign}${t.pnl.toLocaleString()}</td>
                        <td class="${pnlCls}">${pnlSign}${t.pnl_pct}%</td>
                        <td>${t.holding_days}d</td>
                        <td>${t.exit_reason}</td>
                        ${!isRotation ? `<td>${t.zone_bottom != null ? (t.zone_top != null ? t.zone_bottom.toLocaleString() + ' – ' + t.zone_top.toLocaleString() : t.zone_bottom.toLocaleString()) : '—'}</td>
                        <td>${t.entry_dist_pct != null ? t.entry_dist_pct + '%' : '—'}</td>` : ''}
                    </tr>
                `;
            }).join('');

            document.getElementById('backtest-trades-body').innerHTML = `
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            ${isRotation ? '<th>Ticker</th>' : ''}
                            <th>Entry Date</th>
                            <th>Entry Time</th>
                            <th>Entry Price</th>
                            <th>Shares</th>
                            <th>Exit Date</th>
                            <th>Exit Time</th>
                            <th>Exit Price</th>
                            <th>P&L</th>
                            <th>P&L %</th>
                            <th>Hold</th>
                            <th>Reason</th>
                            ${!isRotation ? '<th>Support</th><th>Distance</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function closeBacktest() {
            document.getElementById('backtest-results').classList.add('hidden');
        }

        // ============ Trade Explain ============

        async function explainTrade() {
            const symbol = document.getElementById('explain-symbol').value;
            const strategy = document.getElementById('explain-strategy').value;
            const entryDate = document.getElementById('explain-date').value;

            if (!symbol) { showToast('Select a symbol', 'error'); return; }
            if (!entryDate) { showToast('Select an entry date', 'error'); return; }

            const btn = document.getElementById('run-explain-btn');
            btn.classList.add('loading');
            btn.disabled = true;
            btn.textContent = 'Loading...';

            const container = document.getElementById('trade-explain-content');
            container.innerHTML = `<div class="loading-container"><div class="loader"></div><span>Fetching trade data for ${symbol}...</span></div>`;
            document.getElementById('trade-explain-results').classList.remove('hidden');

            try {
                const res = await fetch('/api/momentum/explain-trade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, strategy, entry_date: entryDate })
                });
                const data = await res.json();

                if (data.success) {
                    renderTradeExplanation(data.data);
                    showToast(`Trade explained: ${symbol} ${strategy}`, 'success');
                } else {
                    container.innerHTML = `<div class="empty-state" style="color:var(--red);">${data.error || 'Failed to explain trade'}</div>`;
                    showToast(data.error || 'Failed', 'error');
                }
            } catch (e) {
                container.innerHTML = `<div class="empty-state" style="color:var(--red);">Request failed</div>`;
                showToast('Request failed', 'error');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.textContent = 'Explain Trade';
            }
        }

        function renderTradeExplanation(d) {
            const r = d.result;
            const fmt = (n) => Number(n).toLocaleString('en-IN', {maximumFractionDigits: 2});
            const bannerCls = r.winner ? 'winner' : 'loser';
            const sign = r.total_pnl >= 0 ? '+' : '';

            let html = '';

            // Result banner
            html += `<div class="explain-banner ${bannerCls}">
                ${r.winner ? 'Winner' : 'Loser'} &nbsp; ${sign}&#8377;${fmt(r.total_pnl)} &nbsp; (${sign}${r.total_pnl_pct}%) &nbsp; ${r.holding_days}d hold
            </div>`;

            // Setup card
            const s = d.setup;
            html += `<div class="explain-card">
                <div class="explain-card-title">Setup &mdash; Why This Trade Was Taken</div>`;
            if (s.description) {
                html += `<p class="explain-desc">"${s.description}"</p>`;
            }
            if (s.strategy === 'J') {
                html += `<p><span class="detail-label">Weekly Support:</span> <span class="detail-value">&#8377;${fmt(s.weekly_support)}</span></p>`;
                html += `<p><span class="detail-label">Weekly Low Stop:</span> <span class="detail-value">&#8377;${fmt(s.weekly_low_stop)}</span></p>`;
                html += `<p><span class="detail-label">IBS:</span> <span class="detail-value">${s.ibs}</span></p>`;
                html += `<p><span class="detail-label">CCI(20):</span> <span class="detail-value">${s.cci20}</span></p>`;
                html += `<p><span class="detail-label">Distance from Support:</span> <span class="detail-value">${s.distance_from_support}</span></p>`;
            } else if (s.strategy === 'T') {
                html += `<p><span class="detail-label">EMA(20):</span> <span class="detail-value">&#8377;${fmt(s.ema20)}</span></p>`;
                html += `<p><span class="detail-label">Upper Keltner:</span> <span class="detail-value">&#8377;${fmt(s.upper_keltner)}</span></p>`;
                html += `<p><span class="detail-label">ATR(14):</span> <span class="detail-value">&#8377;${fmt(s.atr14)}</span></p>`;
                html += `<p><span class="detail-label">Last Keltner Touch:</span> <span class="detail-value">${s.last_keltner_touch}</span></p>`;
                html += `<p><span class="detail-label">Pullback Depth:</span> <span class="detail-value">${s.pullback_depth}</span></p>`;
            } else if (s.strategy === 'R') {
                if (s.swing_low_1) {
                    html += `<p><span class="detail-label">Swing Low 1:</span> <span class="detail-value">&#8377;${fmt(s.swing_low_1.price)} on ${s.swing_low_1.date} (RSI ${s.swing_low_1.rsi})</span></p>`;
                    html += `<p><span class="detail-label">Swing Low 2:</span> <span class="detail-value">&#8377;${fmt(s.swing_low_2.price)} on ${s.swing_low_2.date} (RSI ${s.swing_low_2.rsi})</span></p>`;
                    html += `<p><span class="detail-label">RSI Divergence:</span> <span class="detail-value">${s.rsi_divergence}</span></p>`;
                    html += `<p><span class="detail-label">Price Drop:</span> <span class="detail-value">${s.price_drop}</span></p>`;
                    html += `<p><span class="detail-label">Structural Stop:</span> <span class="detail-value">&#8377;${fmt(s.structural_stop)} (${s.stop_distance} away)</span></p>`;
                }
            }
            html += `</div>`;

            // Entry card
            const e = d.entry;
            html += `<div class="explain-card">
                <div class="explain-card-title">Entry</div>
                <p><span class="detail-label">Date:</span> <span class="detail-value">${e.date}</span></p>
                <p><span class="detail-label">Price:</span> <span class="detail-value">&#8377;${fmt(e.price)}</span></p>
                <p><span class="detail-label">Candle:</span> <span class="detail-value">O:${fmt(e.open)} H:${fmt(e.high)} L:${fmt(e.low)} C:${fmt(e.close)}</span></p>
                <p><span class="detail-label">Stop:</span> <span class="detail-value">&#8377;${fmt(e.stop)} (${e.stop_type}, ${e.stop_pct} away)</span></p>
                <p><span class="detail-label">Shares:</span> <span class="detail-value">${e.shares}</span></p>
                <p><span class="detail-label">Capital:</span> <span class="detail-value">&#8377;${fmt(e.capital)}</span></p>
            </div>`;

            // Exit progression
            html += `<div class="explain-card">
                <div class="explain-card-title">Exit Progression</div>`;
            d.exits.forEach(ex => {
                const pnlCls = ex.pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                const pnlSign = ex.pnl >= 0 ? '+' : '';
                html += `<div class="exit-stage">
                    <div class="exit-stage-num">#${ex.stage}</div>
                    <div class="exit-stage-detail">
                        <div class="exit-line"><strong>${ex.date}</strong> &nbsp; &#8377;${fmt(ex.price)} &nbsp; ${ex.shares}sh &nbsp; <span class="${pnlCls}">${ex.pnl_pct}</span> &nbsp; <span class="${pnlCls}">${pnlSign}&#8377;${fmt(ex.pnl)}</span></div>
                        <div class="exit-reason">${ex.reason}</div>
                    </div>
                </div>`;
            });
            html += `</div>`;

            document.getElementById('trade-explain-content').innerHTML = html;
        }

        function closeTradeExplain() {
            document.getElementById('trade-explain-results').classList.add('hidden');
        }

        // ============ Batch Backtest ============

        async function runBatchBacktest(universe = 50) {
            const fromDate = document.getElementById('backtest-from').value;
            const toDate = document.getElementById('backtest-to').value;
            const periodLabel = document.getElementById('backtest-from').value + ' to ' + document.getElementById('backtest-to').value;
            const universeLabel = `Nifty ${universe}`;

            const btnId = universe === 100 ? 'run-batch100-btn' : 'run-batch-btn';
            const btn = document.getElementById(btnId);
            btn.classList.add('loading');
            btn.disabled = true;
            btn.textContent = 'Running...';

            // Disable the other button too
            const otherBtnId = universe === 100 ? 'run-batch-btn' : 'run-batch100-btn';
            const otherBtn = document.getElementById(otherBtnId);
            otherBtn.disabled = true;

            // Show batch results area with loading
                        document.getElementById('backtest-results').classList.add('hidden');
            document.getElementById('batch-results').classList.remove('hidden');
            document.getElementById('batch-title').textContent = `Batch Backtest — All Strategies × ${universeLabel} — ${periodLabel}`;
            document.getElementById('batch-table-container').innerHTML = `
                <div class="loading-container">
                    <div class="loader"></div>
                    <span>Starting batch backtest...</span>
                    <span class="progress-text" id="batch-progress-text"></span>
                </div>
            `;

            // Poll progress
            const progressInterval = setInterval(async () => {
                try {
                    const res = await fetch('/api/momentum/backtest-all/progress');
                    const progress = await res.json();
                    if (progress.in_progress && progress.total > 0) {
                        const pct = Math.round((progress.current / progress.total) * 100);
                        const el = document.getElementById('batch-progress-text');
                        if (el) el.textContent = `Scanning ${progress.ticker}... ${progress.current}/${progress.total} (${pct}%)`;
                    }
                } catch (e) {}
            }, 1000);

            try {
                const res = await fetch('/api/momentum/backtest-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ from_date: fromDate, to_date: toDate, universe: universe })
                });
                const data = await res.json();
                clearInterval(progressInterval);

                if (data.success) {
                    renderBatchResults(data.data);
                    showToast(`Batch backtest complete: ${data.data.rows.length} stocks × ${data.data.columns.length} strategies`, 'success');
                } else {
                    document.getElementById('batch-table-container').innerHTML = `
                        <div class="empty-state" style="color: var(--red);">${data.error || 'Batch backtest failed'}</div>
                    `;
                    showToast(data.error || 'Batch backtest failed', 'error');
                }
            } catch (e) {
                clearInterval(progressInterval);
                document.getElementById('batch-table-container').innerHTML = `
                    <div class="empty-state" style="color: var(--red);">Batch backtest request failed</div>
                `;
                showToast('Batch backtest failed', 'error');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.textContent = `Backtest All (${universeLabel})`;
                otherBtn.disabled = false;
            }
        }

        function renderBatchResults(data) {
            batchResultData = data;
            document.getElementById('batch-download-btn').classList.remove('hidden');
            const columns = data.columns;
            const rows = data.rows;

            // Build header
            let headerHtml = '<th class="sticky-col">Stock</th>';
            columns.forEach(col => {
                headerHtml += `<th>${col}</th>`;
            });

            // Build body rows
            const colTotals = {};
            columns.forEach(col => { colTotals[col] = 0; });

            let bodyHtml = '';
            rows.forEach(row => {
                bodyHtml += '<tr>';
                bodyHtml += `<td class="sticky-col">${row.symbol}</td>`;
                columns.forEach(col => {
                    const cell = row.results[col];
                    if (cell === null || cell === undefined) {
                        bodyHtml += '<td class="batch-cell-na">--</td>';
                    } else {
                        const pnl = cell.total_pnl;
                        colTotals[col] += pnl;
                        const sign = pnl >= 0 ? '+' : '';
                        const formatted = sign + Math.round(pnl).toLocaleString('en-IN');
                        let cls = 'batch-cell-bad';
                        if (pnl > 0 && cell.return_pct > 5) cls = 'batch-cell-good';
                        else if (pnl >= 0) cls = 'batch-cell-ok';
                        const wr = cell.win_rate;
                        const tooltip = `${cell.trades} trades, ${cell.return_pct >= 0 ? '+' : ''}${cell.return_pct}% return, PF ${cell.profit_factor}`;
                        bodyHtml += `<td class="${cls}" title="${tooltip}">${formatted}<br><span style="opacity:0.6;font-size:10px">WR: ${wr}%</span></td>`;
                    }
                });
                bodyHtml += '</tr>';
            });

            // Totals row
            bodyHtml += '<tr class="batch-total-row">';
            bodyHtml += '<td class="sticky-col">TOTAL</td>';
            columns.forEach(col => {
                const total = colTotals[col];
                const sign = total >= 0 ? '+' : '';
                const formatted = sign + Math.round(total).toLocaleString('en-IN');
                const cls = total >= 0 ? 'batch-cell-good' : 'batch-cell-bad';
                bodyHtml += `<td class="${cls}">${formatted}</td>`;
            });
            bodyHtml += '</tr>';

            document.getElementById('batch-table-container').innerHTML = `
                <table class="batch-table">
                    <thead><tr>${headerHtml}</tr></thead>
                    <tbody>${bodyHtml}</tbody>
                </table>
            `;
        }

        function closeBatchBacktest() {
            document.getElementById('batch-results').classList.add('hidden');
        }

        // ============ Portfolio Backtest (10L) ============

        async function runPortfolioBacktest(universe = 50) {
            const fromDate = document.getElementById('backtest-from').value;
            const toDate = document.getElementById('backtest-to').value;
            const periodLabel = document.getElementById('backtest-from').value + ' to ' + document.getElementById('backtest-to').value;
            const universeLabel = `Nifty ${universe}`;
            const capitalLakhs = parseInt(document.getElementById('portfolio-capital').value);
            const perStock = parseInt(document.getElementById('portfolio-per-stock').value);
            const stratVal = document.getElementById('portfolio-strategy').value;
            const stratMap = {'JTR3': ['J','T','R'], 'JT3': ['J','T'], 'J3': ['J'], 'T3': ['T'], 'R3': ['R']};
            const strategies = stratMap[stratVal] || [stratVal];
            const threeStageExit = true;
            const entriesPerDay = parseInt(document.getElementById('portfolio-entries-per-day').value);

            const btnId = universe === 100 ? 'run-portfolio100-btn' : 'run-portfolio50-btn';
            const btn = document.getElementById(btnId);
            btn.classList.add('loading');
            btn.disabled = true;
            btn.textContent = 'Running...';

            // Disable the other portfolio button too
            const otherBtnId = universe === 100 ? 'run-portfolio50-btn' : 'run-portfolio100-btn';
            const otherBtn = document.getElementById(otherBtnId);
            otherBtn.disabled = true;

            // Show backtest results area with loading
                        document.getElementById('batch-results').classList.add('hidden');
            document.getElementById('backtest-results').classList.remove('hidden');
            document.getElementById('backtest-summary').innerHTML = '';
            document.getElementById('backtest-trades-body').innerHTML = `
                <div class="loading-container">
                    <div class="loader"></div>
                    <span>Starting portfolio backtest...</span>
                    <span class="progress-text" id="portfolio-progress-text"></span>
                </div>
            `;

            // Poll progress
            const progressInterval = setInterval(async () => {
                try {
                    const res = await fetch('/api/momentum/backtest-portfolio/progress');
                    const progress = await res.json();
                    if (progress.in_progress && progress.total > 0) {
                        const pct = Math.round((progress.current / progress.total) * 100);
                        const el = document.getElementById('portfolio-progress-text');
                        if (el) el.textContent = `${progress.ticker}... ${progress.current}/${progress.total} (${pct}%)`;
                    }
                } catch (e) {}
            }, 1000);

            try {
                const res = await fetch('/api/momentum/backtest-portfolio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ from_date: fromDate, to_date: toDate, universe: universe,
                        capital_lakhs: capitalLakhs, per_stock: perStock, strategies: strategies,
                        entries_per_day: entriesPerDay, three_stage_exit: threeStageExit })
                });
                const data = await res.json();
                clearInterval(progressInterval);

                if (data.success) {
                    renderPortfolioResults(data.data, universeLabel, periodLabel);
                    showToast(`Portfolio backtest complete: ${data.data.trades.length} trades`, 'success');
                } else {
                    document.getElementById('backtest-trades-body').innerHTML = `
                        <div class="empty-state" style="color: var(--red);">${data.error || 'Portfolio backtest failed'}</div>
                    `;
                    showToast(data.error || 'Portfolio backtest failed', 'error');
                }
            } catch (e) {
                clearInterval(progressInterval);
                document.getElementById('backtest-trades-body').innerHTML = `
                    <div class="empty-state" style="color: var(--red);">Portfolio backtest request failed</div>
                `;
                showToast('Portfolio backtest failed', 'error');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.textContent = `Backtest (${universeLabel})`;
                otherBtn.disabled = false;
            }
        }

        function renderPortfolioResults(data, universeLabel, periodLabel) {
            portfolioResultData = data;
            document.getElementById('portfolio-download-btn').classList.remove('hidden');
            const s = data.summary;
            const capLabel = `${data.capital_lakhs}L`;
            const stratLabel = data.strategies_label || 'J+T';

            // Title
            document.getElementById('backtest-title').textContent =
                `Portfolio ${capLabel} — ${stratLabel} — ${universeLabel} — ${periodLabel} (${data.start_date} to ${data.end_date})`;
            document.getElementById('backtest-trade-count').textContent = `${s.total_trades} trades`;

            // Summary cards
            const pnlClass = s.total_pnl >= 0 ? 'positive' : 'negative';
            const pnlSign = s.total_pnl >= 0 ? '+' : '';
            const retSign = s.total_return_pct >= 0 ? '+' : '';

            document.getElementById('backtest-summary').innerHTML = `
                <div class="summary-card">
                    <div class="label">Total P&L</div>
                    <div class="value ${pnlClass}">${pnlSign}${s.total_pnl.toLocaleString()}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Return (on ${data.effective_capital_lakhs || data.capital_lakhs}L)</div>
                    <div class="value ${pnlClass}">${retSign}${s.total_return_pct}%</div>
                </div>
                <div class="summary-card">
                    <div class="label">Win Rate</div>
                    <div class="value">${s.win_rate}%</div>
                </div>
                <div class="summary-card">
                    <div class="label">Profit Factor</div>
                    <div class="value">${s.profit_factor}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Total Trades</div>
                    <div class="value">${s.total_trades}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Max Positions</div>
                    <div class="value">${data.max_positions_used}/${data.max_positions}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Signals Missed</div>
                    <div class="value">${data.missed_signals}/${data.total_signals}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Avg Hold Days</div>
                    <div class="value">${s.avg_holding_days}</div>
                </div>
            `;

            // Trade log table
            if (!data.trades || data.trades.length === 0) {
                document.getElementById('backtest-trades-body').innerHTML = '<div class="empty-state">No trades in this period</div>';
                return;
            }

            let sortedTrades = [...data.trades];
            const sortArrow = (col, dir) => portfolioSortCol === col ? (dir === 'asc' ? ' ▲' : ' ▼') : '';

            function renderPortfolioRows(trades) {
                return trades.map((t, i) => {
                    const pnlCls = t.pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                    const pnlSign = t.pnl >= 0 ? '+' : '';
                    return `
                        <tr>
                            <td>${i + 1}</td>
                            <td><strong>${t.symbol}</strong></td>
                            <td>${t.strategy}</td>
                            <td>${t.entry_date}</td>
                            <td class="price">${t.entry_price.toLocaleString()}</td>
                            <td>${t.shares}</td>
                            <td>${t.exit_date}</td>
                            <td class="price">${t.exit_price.toLocaleString()}</td>
                            <td class="${pnlCls}">${pnlSign}${t.pnl.toLocaleString()}</td>
                            <td class="${pnlCls}">${pnlSign}${t.pnl_pct}%</td>
                            <td>${t.holding_days}d</td>
                            <td>${t.exit_reason}</td>
                            <td class="price">${(t.capital_used || 0).toLocaleString()}</td>
                            <td class="price ${(t.capital_available || 0) < 0 ? 'pnl-negative' : ''}">${(t.capital_available || 0).toLocaleString()}</td>
                        </tr>
                    `;
                }).join('');
            }

            function sortPortfolioBy(col) {
                if (portfolioSortCol === col) {
                    portfolioSortDir = portfolioSortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    portfolioSortCol = col;
                    portfolioSortDir = 'asc';
                }
                const key = col === 'entry' ? 'entry_date' : 'exit_date';
                sortedTrades.sort((a, b) => {
                    const cmp = a[key].localeCompare(b[key]);
                    return portfolioSortDir === 'asc' ? cmp : -cmp;
                });
                const tbody = document.querySelector('#backtest-trades-body table tbody');
                if (tbody) tbody.innerHTML = renderPortfolioRows(sortedTrades);
                // Update header arrows
                document.querySelectorAll('#backtest-trades-body th[data-sort]').forEach(th => {
                    const c = th.dataset.sort;
                    const base = c === 'entry' ? 'Entry Date' : 'Exit Date';
                    th.textContent = base + (portfolioSortCol === c ? (portfolioSortDir === 'asc' ? ' ▲' : ' ▼') : '');
                });
            }
            window._sortPortfolioBy = sortPortfolioBy;

            document.getElementById('backtest-trades-body').innerHTML = `
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Symbol</th>
                            <th>Strategy</th>
                            <th data-sort="entry" onclick="window._sortPortfolioBy('entry')" style="cursor:pointer">Entry Date${sortArrow('entry', portfolioSortDir)}</th>
                            <th>Entry Price</th>
                            <th>Shares</th>
                            <th data-sort="exit" onclick="window._sortPortfolioBy('exit')" style="cursor:pointer">Exit Date${sortArrow('exit', portfolioSortDir)}</th>
                            <th>Exit Price</th>
                            <th>P&L</th>
                            <th>P&L %</th>
                            <th>Hold</th>
                            <th>Reason</th>
                            <th>Trade Cost</th>
                            <th>Free Capital</th>
                        </tr>
                    </thead>
                    <tbody>${renderPortfolioRows(sortedTrades)}</tbody>
                </table>
            `;
        }

        function downloadPortfolioCSV() {
            if (!portfolioResultData) return;
            const data = portfolioResultData;
            const s = data.summary;
            const q = (v) => `"${String(v).replace(/"/g, '""')}"`;

            const header = ['#','Symbol','Strategy','Entry Date','Entry Price','Shares','Exit Date','Exit Price','P&L','P&L %','Hold Days','Reason','Trade Cost','Free Capital'].map(q);
            const csvRows = [header.join(',')];

            data.trades.forEach((t, i) => {
                const sign = t.pnl >= 0 ? '+' : '';
                csvRows.push([
                    i + 1, q(t.symbol), q(t.strategy), q(t.entry_date),
                    t.entry_price, t.shares, q(t.exit_date), t.exit_price,
                    `${sign}${t.pnl}`, `${sign}${t.pnl_pct}%`, t.holding_days, q(t.exit_reason), t.capital_used || 0, t.capital_available || 0
                ].join(','));
            });

            // Summary row
            csvRows.push('');
            csvRows.push(`Total P&L,${s.total_pnl}`);
            csvRows.push(`Return %,${s.total_return_pct}%`);
            csvRows.push(`Win Rate,${s.win_rate}%`);
            csvRows.push(`Profit Factor,${s.profit_factor}`);
            csvRows.push(`Total Trades,${s.total_trades}`);
            csvRows.push(`Max Positions,${data.max_positions_used}/${data.max_positions}`);
            csvRows.push(`Signals Missed,${data.missed_signals}/${data.total_signals}`);

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().slice(0, 10);
            a.download = `portfolio_backtest_${data.capital_lakhs}L_${date}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadBatchCSV() {
            if (!batchResultData) return;
            const cols = batchResultData.columns;
            const rows = batchResultData.rows;

            const q = (v) => `"${String(v).replace(/"/g, '""')}"`;

            // Header: Stock, then one column per strategy
            let header = [q('Stock')];
            cols.forEach(col => { header.push(q(col)); });

            const csvRows = [header.join(',')];

            // Data rows — each cell: "P&L (WR: xx%)"
            const colTotals = {};
            cols.forEach(col => { colTotals[col] = 0; });

            rows.forEach(row => {
                const line = [q(row.symbol)];
                cols.forEach(col => {
                    const cell = row.results[col];
                    if (cell === null || cell === undefined) {
                        line.push(q('--'));
                    } else {
                        colTotals[col] += cell.total_pnl;
                        const pnl = Math.round(cell.total_pnl);
                        const sign = pnl >= 0 ? '+' : '';
                        line.push(q(`${sign}${pnl} (WR: ${cell.win_rate}%)`));
                    }
                });
                csvRows.push(line.join(','));
            });

            // Totals row
            const totalLine = [q('TOTAL')];
            cols.forEach(col => {
                const total = Math.round(colTotals[col]);
                const sign = total >= 0 ? '+' : '';
                totalLine.push(q(`${sign}${total}`));
            });
            csvRows.push(totalLine.join(','));

            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().slice(0, 10);
            a.download = `batch_backtest_${date}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============ Paper Trading ============

        async function executePaperTrade(ticker, action, price, btn) {
            try {
                const res = await fetch('/api/trade/paper', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker, action, price, quantity: 1 })
                });
                const data = await res.json();

                if (data.success) {
                    showToast(`Paper ${action}: ${ticker} @ ₹${price}`, 'success');
                    loadPaperTradesCount();
                    btn.classList.add('executed');
                    btn.textContent = 'Done';
                    setTimeout(() => {
                        btn.classList.remove('executed');
                        btn.textContent = action === 'SELL' ? 'Sell' : 'Buy';
                    }, 2000);
                } else {
                    showToast(data.error || 'Trade failed', 'error');
                }
            } catch (e) {
                showToast('Trade failed', 'error');
            }
        }

        async function loadPaperTradesCount() {
            try {
                const res = await fetch('/api/trade/paper/portfolio');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('paper-trades-count').textContent = data.portfolio.total_trades;
                }
            } catch (e) {}
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
